\documentclass[11pt]{article}

\usepackage{fullpage}
\usepackage{amsmath,amsfonts,amsthm,mathrsfs,mathpazo,xspace,hyperref,graphicx}
\usepackage{endnotes}
\usepackage{color}
\usepackage{bm}
\usepackage{times}
\usepackage{amssymb,latexsym}
\usepackage{float}

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{fact}[theorem]{Fact}
\newtheorem{corollary}[theorem]{Corollary}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}

\newcommand{\beq}{\begin{eqnarray}}
\newcommand{\eeq}{\end{eqnarray}}

\newcommand{\ket}[1]{|#1\rangle}
\newcommand{\bra}[1]{\langle#1|}
\newcommand{\proj}[1]{\ket{#1}\!\bra{#1}}
\newcommand{\Tr}{\mbox{\rm Tr}}
\newcommand{\Id}{\ensuremath{\mathop{\rm Id}\nolimits}}
\newcommand{\Es}[1]{\ensuremath{\mathop{\textsc{E}}_{#1}}}

\newcommand{\CON}{C}
\newcommand{\DIS}{d}
\newcommand{\Drho}{\DIS_\rho}
\newcommand{\Trho}{\Tr_\rho}

\newcommand{\reg}[1]{{\textsf{#1}}}

\newcommand{\C}{\ensuremath{\mathbb{C}}}
\newcommand{\N}{\ensuremath{\mathbb{N}}}
\newcommand{\F}{\ensuremath{\mathbb{F}}}
\newcommand{\K}{\ensuremath{\mathbb{K}}}
\newcommand{\R}{\ensuremath{\mathbb{R}}}
\newcommand{\Z}{\ensuremath{\mathbb{Z}}}

\newcommand{\mH}{\mathcal{H}}
\newcommand{\Alg}{\mathcal{A}}

\newcommand{\setft}[1]{\mathrm{#1}}
\newcommand{\Density}{\setft{D}}
\newcommand{\Pos}{\setft{Pos}}
\newcommand{\Proj}{\setft{Proj}}
\newcommand{\Obs}{\setft{Obs}}
\newcommand{\Channel}{\setft{C}}
\newcommand{\Unitary}{\setft{U}}
\newcommand{\Herm}{\setft{Herm}}
\newcommand{\Lin}{\setft{L}}
\newcommand{\Trans}{\setft{T}}
\DeclareMathOperator{\poly}{poly}

\newcommand{\eps}{\varepsilon}
\newcommand{\ph}{\ensuremath{\varphi}}

\newcommand{\Acc}{\textsc{Acc}}
\newcommand{\Samp}{\textsc{Samp}}
\newcommand{\Ext}{\ensuremath{\text{Ext}}}

\newcommand{\Hmin}{H_\infty}
\newcommand{\Hmax}{H_{\ensuremath{\text{max}}}}

\newcommand{\CHSH}{{\rm CHSH}}
\newcommand{\EPR}{{\rm EPR}}
\newcommand{\MS}{{\rm MS}}
\newcommand{\basis}{\mathcal{B}}
\newcommand{\pauli}{\mathcal{P}}
\newcommand{\paulip}{\tilde{\mathcal{P}}}
\newcommand{\pbt}{\textsc{pbt}}
\newcommand{\qauli}{\mathcal{Q}}
\newcommand{\rauli}{\mathcal{R}}
\newcommand{\raulip}{\tilde{\mathcal{R}}}
\newcommand{\qaulip}{\tilde{\mathcal{Q}}}
\newcommand{\magic}{\mathcal{M}}
\newcommand{\wagon}{\mathcal{W}}
\newcommand{\aux}{\textsc {aux}}
\newcommand{\ctl}{\textsc {ctl}}
\newcommand{\swap}{\textsc {swap}}
\newcommand{\conj}{\textsc{conj}}
\newcommand{\perm}{\textsc{tens}}
\newcommand{\prodt}{\textsc{prod}}
\newcommand{\comt}{\textsc{com}}
\newcommand{\act}{\textsc{ac}}
\newcommand{\idt}{\textsc{id}}
\newcommand{\bellt}{\textsc{Bell}}

\newcommand{\conjc}{\textsc{conj-cliff}}
\newcommand{\ecliff}{\textsc{e-cliff}}
\newcommand{\cliff}{\textsc{cliff}}
\newcommand{\tom}{\textsc{tom}}
\newcommand{\SWAP}{\textsc{SW}}
\newcommand{\clifford}{\mathcal{C}}
\newcommand{\cliffordga}{{\mathcal{C}_1}}
\newcommand{\cliffordgb}{{\mathcal{C}_2}}
\newcommand{\heisg}{{\mathcal{H}^{(1)}}}
\newcommand{\heisgn}{{\mathcal{H}^{(n)}}}
\newcommand{\heisga}{{\mathcal{H}_1}}
\newcommand{\heisgb}{{\mathcal{H}_{2}}}
\newcommand{\cliffordgan}{{\mathcal{C}^{(n)}_1}}
\newcommand{\cliffordgbn}{{\mathcal{C}^{(n)}_2}}
\newcommand{\cliffordn}{G_\mathcal{C}^{(n)}}
\newcommand{\paulig}{G_{\mathcal{P}}}
\newcommand{\pauligb}{G_{\mathcal{P}_2}}
\newcommand{\paulign}{G_{\mathcal{P}}^{(n)}}
\newcommand{\conjn}{\mathcal{J}^{(n)}\!}
\newcommand{\conjr}{\mathcal{J}\!}
\newcommand{\tr}{\mathcal{T}\!}
\newcommand{\epaulin}{\hat{\mathcal{P}}^{(n)}\!}
\newcommand{\tpaulin}{\tilde{\mathcal{P}}^{(n)}\!}
\newcommand{\paulin}{\mathcal{P}^{(n)}\!}
\newcommand{\ver}{\textsc{V}}
\newcommand{\pv}{\textsc{PV}}
\newcommand{\pp}{\textsc{PP}}
\newcommand{\sk}{\ensuremath{\text{sk}}}

\newcommand{\anote}[1]{\textcolor{blue}{\small {\textbf{(Andrea:} #1 \textbf{) }}}}
\newcommand{\agnote}[1]{\textcolor{cyan}{\small {\textbf{(Alex:} #1 \textbf{) }}}}
\newcommand{\agnew}[1]{\textcolor{cyan}{#1}}


\bibliographystyle{alpha}

\newif\ifnotes\notestrue
%\newif\ifnotes\notesfalse

%\input{../marginnotes}
\input{marginnotes}

\begin{document}

\title{Robust testing of Clifford observables}
\author{}
\date{}
\maketitle

\noteswarning

%=====================%
%\section{Introduction}
%\label{sec:intro}
%=====================%

\tnote{Generic testing will give it, but group has exponential size, so soundness could be exponentially small}\tnote{Not clear if just Pauli conjugation is enough; also relation between Cliffords?}

\tnote{The whole manuscript does not contain enough details to verify that we get $\sqrt{\eps}$ dependence on the error in the end. It would be better to only claim some $\eps^c$, and say somewhere we think the exponent is $1/2$ but we leave the details for later...}

%=====================%
\section{Notation}
\label{sec:prelim}
%=====================%

We introduce specific notation for the formulation of our result on testing. \tnote{some of these will go to general notation common to all parts}
$\mH$ will always denote a finite-dimensional Hilbert space.  We write $\Unitary(\mH)$ for the set of unitary operators, $\Obs(\mH)$ for the set of observables and $\Proj(\mH)$ the set of projective measurements on $\mH$ respectively. We use $e_i \in \{0,1\}^n \subset \R^n$ to denote the indicator string with a $1$ in the $i$-th position and $0$ elsewhere.  


\subsection{Pauli and Clifford groups}
\label{sec:groups}

We use capital letters $X,Z,W,\ldots$ to denote observables. We use greek letters $\sigma$, $\tau$ with a subscript $\sigma_W$, $\tau_W$, to emphasize that the observable $W$ specified as subscript acts in a particular basis. For example, $X$ is an arbitrary observable but $\sigma_X$ is specifically the Pauli $X$ matrix defined in~\eqref{eq:pauli-matrix}. 

For $a\in\{0,1\}^n$ and commuting observables $\sigma_{W_1},\ldots,\sigma_{W_n}$, we write $\sigma_W(a) = \prod_{i=1}^n (\sigma_{W_i})^{a_i}$. The associated projective measurements are $\sigma_{W_i} = \sigma_{W_i}^0 - \sigma_{W_i}^1$ and $\sigma_W^u = \Es{a} (-1)^{u\cdot a} \sigma_W(a)$.  Often the $\sigma_{W_i}$ will be single-qubit observables acting on distinct qubits, in which case each is implicitly tensored with identity outside of the qubit on which it acts. 

Let 
\begin{equation}\label{eq:pauli-matrix}
\sigma_I = \begin{pmatrix} 1 & 0 \\ 0 & 1 \end{pmatrix},\qquad \sigma_X = \begin{pmatrix} 0 & 1 \\ 1 & 0 \end{pmatrix},\qquad \sigma_Y = \begin{pmatrix} 0 & i \\ -i & 0 \end{pmatrix}\qquad\text{and}\qquad \sigma_Z = \begin{pmatrix} 1 & 0 \\ 0 & -1\end{pmatrix}
\end{equation}
denote the standard Pauli matrices acting on a qubit. The single-qubit Weyl-Heisenberg group
$$\heisg = H(\Z_2)=\Big\{(-1)^c\sigma_X(a)\sigma_Z(b),\;a,b,c\in\{0,1\}\Big\} $$
is the Pauli group quotiented by the two-element subgroup generated by the complex phase $i$.\footnote{See e.g.~\cite[Section II.A]{gross2006hudson}.} We  let $\heisgn = H(\Z_2^n)$ be the direct product of $n$ copies of $\heisg$.  
%We use $\paulign = \{ \pm\Id,\pm \sigma_X,\pm \sigma_Z,\pm\sigma_Y\}^{\otimes n}$ to denote the $n$-qubit Pauli group. 
The $n$-qubit Clifford group is the normalizer of $\heisgn$ in the unitary group, up to phase: 
$$\cliffordn = \big\{G\in\Unitary((\C^2)^{\otimes n}):\, G \sigma G^\dagger \in \{\pm 1,\pm i\}\heisgn \quad\forall \sigma \in \heisgn\big\}.$$
%An element $H$ of the Clifford group is uniquely characterized by functions $h_S:\{0,1\}^n\times \{0,1\}^n \to \Z_4$ and $h_X,h_Z:\{0,1\}^n \times \{0,1\}^n \to \{0,1\}^n$ such that $H \sigma_X(a)\sigma_Z(b) H^\dagger = i^{h_S(a,b)} \sigma_X(h_X(a,b))\sigma_Z(h_Z(a,b))$ for all $(a,b)\in\{0,1\}^n\times \{0,1\}^n$. 
%The Clifford group has $24$ elements. Each element can be characterized by a $2\times 2$ symplectic matrix over $\Z_4$ which describes its action on the Pauli group. 
Some Clifford observables we will use include 
$$ \sigma_H = \frac{\sigma_X+\sigma_Z}{\sqrt{2}},\qquad \sigma_{H'} = \frac{\sigma_X-\sigma_Z}{\sqrt{2}},\qquad \sigma_F = \frac{-\sigma_X+\sigma_Y}{\sqrt{2}},\qquad \sigma_{G} = \frac{\sigma_X+\sigma_Y}{\sqrt{2}}.$$
Note that  $\sigma_H$ and $\sigma_{H'}$ are characterized by $\sigma_X \sigma_H \sigma_X = \sigma_{H'}$ and $\sigma_Z \sigma_H \sigma_Z = -\sigma_{H'}$. Similarly, $\sigma_F$ and $\sigma_G$ are characterized by $\sigma_X \sigma_F \sigma_X = -\sigma_G$ and $\sigma_Y \sigma_F \sigma_Y = \sigma_G$. 

%============================%
\subsection{Testing}
\label{sec:general-rigidity}
%============================%

\paragraph{Distance measures.}
Ultimately our goal is to test that a player implements a certain tensor product of single-qubit or two-qubit measurements defined by observables such as $\sigma_X$, $\sigma_Y$, or $\sigma_G$. Since it is impossible to detect whether a player applies a certain operation $X$ on state $\ket{\psi}$, or $VXV^\dagger$ on state $V\ket{\psi}$, for any isometry $V:\Lin(\mH)\to\Lin(\mH')$ such that $V^\dagger V = \Id$, we will (as is standard in testing) focus on testing identity up to \emph{local isometries}. Towards this we introduce the following important piece of notation: 

\begin{definition}
For finite-dimensional Hilbert spaces $\mH_{\reg{A}}$ and $\mH_{\reg{A'}}$, $\delta>0$, and operators $R \in\Lin(\mH_{\reg{A}})$ and $S\in\Lin(\mH_{\reg{A'}})$ we say that $R$ and $S$ are $\delta$-isometric with respect to $\ket{\psi} \in \mH_{\reg{A}} \otimes \mH_{\reg{B}}$, and write $R\simeq_\delta S$, if there exists an isometry $V:\mH_{\reg{A}}\to\mH_{\reg{A'}}$ such that 
$$\big\|( R-V^\dagger SV)\otimes \Id_{\reg{B}} \ket{\psi}\big\|^2=O(\delta).$$
If $V$ is the identity then we further say that $R$ and $S$ are $\delta$-equivalent, and write $R\approx_\delta S$ for $\| ( R- S) \otimes \Id_{\reg{B}} \ket{\psi}\|^2=O(\delta)$.
\end{definition}

The notation $R\simeq_\delta S$ carries some ambiguity, as it does not specify the state $\ket{\psi}$. The latter should always be clear from context: we will often simply write that $R$ and $S$ are $\delta$-isometric, without explicitly specifying $\ket{\psi}$ or the isometry. The relation is transitive, but not reflexive: the operator on the right will always act on a space of dimension at least as large as that on which the operator on the left acts. The notion of $\delta$-equivalence is both transitive (its square root obeys the triangle inequality) and reflexive, and we will use it as our main notion of distance. 

\paragraph{Tests.}
We formulate our tests as two-player games in which both players are treated symmetrically.  We often use the same symbol, a capital letter $X,Z,W,\ldots,$ to denote a question in the game and the associated projective measurement $\{W^a\}$ applied by the player upon receipt of that question. To a projective measurement with outcomes in $\{0,1\}^n$ we  associate a family of observables $W(u)$ parametrized by $n$-bit strings $u\in\{0,1\}^n$, defined by $W(u) = \sum_a (-1)^{u\cdot a} W^a$. If $n=1$ we simply write $W=W(1)=W^0-W^1$; note that $W(0)=\Id$.

The games we consider always implicitly include a ``consistency test'' which is meant to enforce that whenever both players are sent identical questions, they produce matching answers. More precisely, let $T$ be any of the two-player tests described in the paper. Let $\Pr_T(W,W')$ be the distribution on questions $(W,W')$ to the players that is specified by $T$. Since the players are always treated symmetrically, $\Pr_T(\cdot,\cdot)$ is permutation-invariant. Let $\Pr_T(\cdot)$ denote the marginal on either player. Then instead of executing the test $T$ as described, the verifier performs the following:
\begin{enumerate}
\item[(i)] With probability $1/2$, execute $T$.
\item[(ii)] With probability $1/2$, select a random question $W$ according to $\Pr_T(W)$. Send $W$ to both players. Accept if and only if the players' answers are equal. 
\end{enumerate}
Then success with probability at least $1-\eps$ in the modified test implies success with probability at least $1-2\eps$ in the original test, as well as in the consistency test. If $\{W_{\reg{A}}^a\}$ and $\{W_{\reg{B}}^b\}$ are the players' corresponding measurements (which we will always assume are projective; see below), the latter condition implies 
\begin{align}
\sum_a \|(W_{\reg{A}}^a \otimes \Id - \Id \otimes W_{\reg{B}}^a)\ket{\psi}_{\reg{AB}}\|^2 &= 2-2 \sum_a \bra{\psi} W_{\reg{A}}^a \otimes W_{\reg{B}}^a \ket{\psi} \notag\\ 
&\leq 4 \eps,\label{eq:consistency}
\end{align}
so that $W_{\reg{A}}^a \otimes \Id \approx_{\sqrt{\eps}} \Id \otimes W_{\reg{b}}^a$. Similarly, if $W_{\reg{A}}$, $W_{\reg{B}}$ are observables for the players that succeeds in the consistency test with probability $1-2\eps$ we obtain $W_{\reg{A}}\otimes \Id \approx_{\sqrt{\eps}} \Id \otimes W_{\reg{B}}$. We will often use both relations to ``switch'' operators from one player's space to the other's; as a result we will also often omit to  explicitly specify on which player's space an observable is applied. 

\paragraph{Strategies.} Given a two-player game, or test, a strategy for the players is constituted of a bipartite entangled state $\ket{\psi} \in \mH_\reg{A} \otimes \mH_\reg{B}$ together with families of projective  measurements $\{W^a_\reg{A}\}$ for Alice and $\{W_\reg{B}^a\}$ for Bob, one for each question $W$ that can be sent to either player in the test.\footnote{We make the assumption that the players employ a pure-state strategy for convenience, but it is easy to check that all proofs extend to the case of a mixed strategy. Moreover, it is always possible (and we always do) to consider projective strategies only by applying Naimark's dilation theorem, adding an auxiliary local system to each player as necessary, since no bound is assumed on the dimension of their systems.}  %The fact that both players will always be treated symmetrically allows us to assume without loss of generality that $\mH_\reg{A} = \mH_\reg{B}$, $\ket{\psi}$ is permutation-invariant, and for any question $W$, $W_\reg{A}^a = W_\reg{B}^a$ for all answers $a$ (see e.g. Lemma~4 in~\cite{kempe2011entangled}).
We will loosely refer to a strategy for the players as $(W,\ket{\psi})$, with the symbol $W$ referring to the complete set of POVM used by the players in the game; taking advantage of  symmetry we often omit the subscript $\reg{A}$ or $\reg{B}$, as all statements involving observables for one player hold verbatim with the other player's observables as well. 

\paragraph{Relations.}
We use $\mathcal{R}$ to denote a set of relations over variables $X,Z,W,\ldots,$ such as
$$\mathcal{R}=\big\{XZXZ=-\Id,\, HX=ZH,\,X,Z,H\in\Obs\big\}.$$
We only consider relations that can be brought in the form either $f(W) = (-1)^a W_1\cdots W_k = \Id$, \anote{I think you mentioned that we just drop this, as we are also testing relations that are not of this form. If we drop it, Definitions 2 and 3 might need to be adapted.}\tnote{My suggested way out was to keep it, but include the two possible forms or relations, as in the remainder of the sentence}where the $W_i$ are (not necessarily distinct) unitary variables and $a\in\Z_2$, or $f(W) = W_1 \cdot ( \sum_a \omega_a W_2^a)=\Id$, where $W_1$ is a unitary variable, $\{W_2^a\}$ a POVM with $s$ possible outcomes, and $\omega_a$ are (arbitrary) $s$-th roots of unity.   

\begin{definition}[Rigid self-test]
We say that a set of relations $\mathcal{R}$ is $(c,\delta(\eps))$-testable, on the average under distribution $\mathcal{D}:\mathcal{R}\to[0,1]$, if
  there exists a game (or test) $G$ with question set $\mathcal{Q}$ that
  includes (at least) a symbol for each variable in $\mathcal{R}$ that is either an observable or a POVM and such that:
\begin{itemize}
\item (\emph{Completeness}) There exists a set of operators which exactly satisfy all relations in $\mathcal{R}$ and a strategy for the players which uses these operators (together possibly with others for the additional questions) that has success probability at least $c$;
\item (\emph{Soundness}) For any $\eps>0$ and any strategy $(W,\ket{\psi}_{AB})$ that succeeds in the game with probability at least $c-\eps$ the associated measurement operators satisfy the relations in $\mathcal{R}$ up to $\delta(\eps)$, in the state-dependent norm. More precisely, on average
 over the choice of a relation $f(W)=\Id$ from $\mathcal{R}$ chosen according to $\mathcal{D}$, it holds that $\| \Id\otimes (f(W)-\Id) \ket{\psi}_{\reg{AB}}\|^2 \leq \delta(\eps)$.
\end{itemize}
If both conditions hold we also say that the game $G$ is a robust $(c,s)$ self-test for the relations $\mathcal{R}$. 
\end{definition}

\tnote{should discuss connection with BCS}
Even though our definition is general, in this paper we only consider games with perfect completeness, $c=1$, so that we usually omit the parameter. The distribution $\mathcal{D}$ will often be implicit from context, and we do not always specify it explicitly (e.g. in case we only measure $\delta(\eps)$ up to multiplicative factors of order $|\mathcal{R}|$ the exact distribution $\mathcal{D}$ does not matter as long as it has complete support). 

\begin{definition}[Stable relations]
We say that a set of relations $\mathcal{R}$ is $\delta(\eps)$-stable, on the average under distribution $\mathcal{D}:\mathcal{R}\to[0,1]$, if for any two families of operators $W_A\in\Lin(\mH_\reg{A})$ and  $W_B\in\Lin(\mH_\reg{B})$ that are consistent on average, i.e. 
$$\Es{f \sim\mathcal{D}} \Es{W \in_U f} \big\| (\Id\otimes W_B - W_A \otimes \Id)\ket{\psi}\big\|^2\leq \eps,$$
where $W \in_U f$ is shorthand for $W$ being a uniformly random operator among those appearing in the relation specified by $f$,
and satisfy the relations on average, i.e. 
$$\Es{\substack{f\sim\mathcal{D}:\\f(W)=\Id \in\mathcal{R}}} \big\|  (f(W_A)- \Id) \otimes \Id \ket{\psi}\big\|^2 \leq \eps,$$
  there exists operators $\hat{W}$ which satisfy the same relations exactly and are $\delta(\eps)$-isometric to the $W$ with respect to $\ket{\psi}$, on the average over the choice of a random relation in $\mathcal{R}$ and a uniformly random $W$ appearing in the relation, i.e. there exists an isometry $V_A$ such that 
  \begin{equation}
    \Es{f \sim\mathcal{D}} \Es{W \in_U f} \big\|( \hat{W}_A-V_A^\dagger W_AV_A)\otimes \Id \ket{\psi}\big\|^2=O(\delta(\eps)).\nonumber
  \end{equation}
	\end{definition}

\subsection{The Magic Square game}
\label{sec:ms}

We use the Magic Square game~\cite{Mermin90} as a building block, noting that it  provides a robust self-test test for the two-qubit Weyl-Heisenberg group (see Section~\ref{sec:groups} for the definition). Questions in this game are specified by a triple of labels corresponding to the same row or column from the square pictured in Figure~\ref{fig:ms} (so a typical question could be $(IZ,XI,XZ)$; there are $6$ questions in total, each a triple). An answer is composed of three values in $\{\pm 1\}$, one for each of the labels making up the question. Answers from the player should be entrywise consistent, and such that the product of the answers associated to any row or column except the last should be $+1$; for the last column it should be $-1$. The labels indicate the ``honest'' strategy for the game, which consists of each player measuring two half-EPR pairs using the commuting Pauli observables indicated by the labels of his question. 

\begin{figure}[H]
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
$IZ$ & $ZI$ & $ZZ$ \\
\hline
$XI$ & $IX$ & $XX$ \\
\hline
$XZ$ & $ZX$ & $YY$\\
\hline
\end{tabular}
\end{center}
\caption{Questions, and a strategy, for the Magic Square game}
\label{fig:ms}
\end{figure}

The following lemma states some consequences of the Magic Square game, interpreted as a self-test (see e.g.~\cite{WBMS16}). 

\begin{lemma}\label{lem:ms-rigid}
Suppose a strategy for the players succeeds with probability at least $1-\eps$ in the Magic Square game. Then there exist  isometries $V_D:\mH_\reg{D} \to (\C^2\otimes \C^2)_{\reg{D'}}\otimes \hat{\mH}_{\hat{\reg{D}}}$, for $D\in\{A,B\}$, such that
$$\big\| (V_A \otimes V_B) \ket{\psi}_{\reg{AB}} - \ket{\EPR}_{\reg{A}'\reg{B}'}^{\otimes 2} \ket{\aux}_{\hat{\reg{A}}\hat{\reg{B}}} \big\|^2 = O(\sqrt{\eps}),$$
and for $W\in \{I,X,Z\}^2 \cup \{YY\}$,
\begin{align*}
\big\| \big(W -V_A^\dagger \sigma_W V_A\big) \otimes \Id_B \ket{\psi} \big\|^2 &= O(\sqrt{\eps}).
\end{align*}
\end{lemma}

%===========================%
\section{Some simple tests}
\label{sec:clifford-test}
%===========================%

In this section, we collect simple tests that will be used as building blocks. We start in Section~\ref{sec:elementary} by reviewing elementary tests whose analysis is either immediate or can be found in the literature. In Section~\ref{sec:bell} we formulate a simple test for measurements in the Bell basis and the associated two-qubit SWAP observable. In Section~\ref{sec:conj-test} we give a test for conjugation of an observable by a unitary. 

%---------------------------%
\subsection{Elementary tests}
\label{sec:elementary}
%---------------------------%


Figure~\ref{fig:elementary} summarizes some useful elementary tests. For each test, ``Inputs'' refers to a subset of designated questions in the test; ``Relation'' indicates a relation that the test aims to certify; ``Test'' describes the certification protocol. (Recall that all our protocols implicitly include a ``consistency'' test in which a question is chosen uniformly at random from the marginal distribution and sent to both players, whose answers are accepted if and only if they are equal.)

\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\idt(A,B)$:
\begin{itemize}
    \item Inputs: $A$, $B$ two observables on the same space $\mH$
    \item Relation: $A=B$
    \item Test: Send $W \in \{A,B\}$ and $W'\in\{A,B\}$, chosen uniformly at random, to the first and second player respectively. Receive an answer in $\{\pm 1\}$ from each player. Accept if and only if the answers are equal whenever the questions are identical. 
\end{itemize}
Test~$\act(X,Z)$:
\begin{itemize}
    \item Inputs: $X$, $Z$ two observables on the same space $\mH$
    \item Relation: $XZ=-ZX$
    \item Test: Execute the Magic Square game, using the label ``$X$'' for the $(2,1)$ entry and ``$Z$'' for the $(1,2)$ entry.  
\end{itemize}
Test~$\comt(A,B)$:
\begin{itemize}
    \item Inputs: $A$, $B$ two observables on the same space $\mH$.
    \item Relation: $AB=BA$
    \item Test: Send $W\in\{A,B\}$ chosen uniformly at random to the first player. Send $(A,B)$ to the second player. Receive a bit $c\in\{\pm 1\}$ from the first player, and two bits $(a',b')\in\{\pm 1\}^2$ from the second. Accept if and only if $c=a'$ if $W=A$, and $c=b'$ if $W=B$. 
\end{itemize}
Test~$\prodt(A,B,C)$:
\begin{itemize}
    \item Inputs: $A$, $B$ and $C$ three observables on the same space $\mH$.
    \item Relations: $AB=BA=C$
    \item Test: Similar to the commutation game, but use $C$ to label the question $(A,B)$.
\end{itemize}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{Some elementary tests.}
\label{fig:elementary}
\end{figure}

\begin{lemma}\label{lem:elementary}
Each of the tests described in Figure~\ref{fig:elementary} is a robust $(1,\delta)$ self-test for the indicated relation(s), for some $\delta = O(\eps^{1/2})$. 
\end{lemma}

\begin{proof}
The proof for each test is similar. As an example we give it for the commutation test $\comt(A,B)$. 

First we verify completeness. Let $A,B$ be two commuting observables on $\mH_{\reg{A}} = \mH_{\reg{B}} = \mH$, and $\ket{\EPR}_{\reg{AB}}$ the maximally entangled state in $\mH_\reg{A}\otimes \mH_\reg{B}$. Upon receiving question $A$ or $B$, the player measures the corresponding observable. If the question is $(A,B)$, he jointly measures $A$ and $B$. This strategy succeeds with probability $1$ in the test. 

Next we establish soundness. Let $\ket{\psi} \in \mH_{\reg{A}}\otimes \mH_\reg{B}$ be a state shared by the players, $A$, $B$ their observables on questions $A,B$, and $\{C^{a,b}\}$ the four-outcome PVM applied on question $(A,B)$. Assume the strategy succeeds with probability at least $1-\eps$. Recall that this includes both the test described in Figure~\ref{fig:elementary}, and the automatic consistency test. Let $C_A = \sum_{a,b} (-1)^a C^{a,b}$ and $C_B = \sum_{a,b} (-1)^b C^{a,b}$. Then $C_A$ and $C_B$ commute. Thus
\begin{align*}
A_\reg{A} B_\reg{A} \otimes \Id_\reg{B}
&\approx_{\sqrt{\eps}} A_\reg{A} \otimes (C_B)_\reg{B}\\
&\approx_{\sqrt{\eps}} \Id_\reg{A} \otimes (C_B)_\reg{B}(C_A)_\reg{B}\\
&=  \Id_\reg{A} \otimes (C_A)_\reg{B}(C_B)_\reg{B}\\
&\approx_{\sqrt{\eps}} B_\reg{A} \otimes (C_A)_\reg{B}\\
&\approx_{\sqrt{\eps}} B_\reg{A} A_\reg{A} \otimes \Id_\reg{B}.
\end{align*}
Here each approximation uses the consistency condition provided by the test, as explained in~\eqref{eq:consistency}. Thus $[A,B] = (AB-BA) \approx_{\sqrt{\eps}} 0$, as desired. 
\end{proof}

We will often make use of the following simple lemma, which expresses an important application of the above tests. 

\begin{lemma}\label{lem:pauli-c}
Let $\ket{\psi} \in \mH_{\reg{A}} \otimes \mH_{\reg{B}}$ and $A,X$ observables on $\mH_{\reg{A}}$ such that there exists an isometry $\mH_{\reg{A}} \simeq \C^2 \otimes \mH_{\hat{\reg{A}}}$ under which the following conditions hold, for some $\delta_1,\delta_2,\delta_3$:\footnote{Note that we allow either $\delta_i$ is allowed to equal $1$, leading to a vacuous condition.}
\begin{enumerate}
\item[(i)] There exists an observable $A'$ on $\mH_\reg{B}$ such that $A\otimes \Id \approx_{\delta_1} \Id \otimes A'$;
\item[(ii)] $\ket{\psi} \simeq_{\delta_1} \ket{\EPR}\ket{\aux}$ and $X\simeq_{\delta_1} \sigma_X \otimes \Id$; 
\item[(iii)] $[A,X]\approx_{\delta_2} 0$;
\item[(iv)] $\{A,X\} \approx_{\delta_3} 0$.
\end{enumerate}
Then there exists Hermitian $A_I,A_X,A_Y,A_Z$ on $\mH_{\hat{\reg{A}}}$ such that $A \simeq_{\delta_1+\delta_2} \Id \otimes A_I + \sigma_X \otimes A_X$ and $A \simeq_{\delta_1 + \delta_3} \sigma_Y \otimes A_Y + \sigma_Z \otimes A_Z$. (A similar claim holds with $X$ replaced by $Z$.)
\end{lemma}

\begin{proof}
After application of the isometry, an arbitrary observable $\tilde{A}$ on  $\C^2 \otimes \mH_{\hat{\reg{A}}}$ has a decomposition $\tilde{A} = \sum_{P\in\{I,X,Y,Z\}} \sigma_P \otimes A_P$, for Hermitian operators $A_P$ on $\mH_{\hat{\reg{A}}}$. We can compute
\begin{align}
[\tilde{A},\sigma_X\otimes \Id] &= -2i\,\sigma_Z \otimes A_Y + 2i\,\sigma_Y \otimes A_Z,\label{eq:pauli-c-1}\\
\{\tilde{A},\sigma_X\otimes \Id\} &= 2\,\sigma_X \otimes A_I + 2 \,\sigma_I \otimes A_X.\label{eq:pauli-c-2}
\end{align} 
Assumptions (i) and (ii) imply $[A,X] \simeq_{\delta_1} [\tilde{A},\sigma_X \otimes \Id]$ \anote{I think this doesn't hold just from (i), since in the second term of $(AX - XA) \ket{\psi}$, $X$ acts on $A\ket{\psi}$ but (i) holds only ``on $\ket{\psi}$''. I think the Lemma should be adapted to include the extra condition ``there exist $A' \in \mathcal{H}_B$ such that $A\ket{\psi} = A'\ket{\psi}$'' so that we can move $A$ to B's side.}\tnote{Ah yes, thanks, done}, so by (iii) and~\eqref{eq:pauli-c-1} we get $\| A_Y \ket{\aux}\|^2 + \|A_Z \ket{\aux}\|^2 = O(\delta_1+\delta_2)$. Similarly, (iv) and~\eqref{eq:pauli-c-2} give $\| A_I \ket{\aux}\|^2 + \|A_X \ket{\aux}\|^2 = O(\delta_1+\delta_3)$.
\end{proof}


\anote{I was wondering if Lemma \ref{lem:pauli-c-n} would fit better in section 3. }\tnote{You're right, it's a ``multi-qubit'' thing. Moved it}


%---------------------------%
\subsection{The Bell basis}
\label{sec:bell}
%---------------------------%

Given two commuting pairs of anti-commuting observables $\{X_1,Z_1\}$ and $\{X_2,Z_2\}$ we provide a test for a four-outcome projective measurement in the Bell basis (i.e. the joint eigenbasis of $X_1X_2$ and $Z_1Z_2$). The same test can be extended to test for the associated $\SWAP$ observable
\begin{equation}\label{eq:def-swap}
 \SWAP \,=\, \frac{1}{4} \big( \Id + X_1X_2 + Z_1Z_2 - (X_1Z_1)(X_2Z_2) \big),
\end{equation}
 which exchanges the two qubits specified by each pair of observables. The Bell measurement test described in Figure~\ref{fig:bell} tests for both. 


\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\bellt(X_1,X_2,Z_1,Z_2)$:
\begin{itemize}
    \item Inputs: For $i\in\{1,2\}$, $\{X_i,Z_i\}$ observables, $\{\Phi^{ab}\}_{a,b\in\{0,1\}}$ a four-outcome projective measurement, and $\SWAP$ an observable, all acting on the same space $\mH$.
    \item Relations: for all $a,b\in\{0,1\}$, $\Phi^{ab} = \frac{1}{4}\big(\Id+(-1)^a Z_1Z_2\big)\big(\Id+(-1)^bX_1X_2\big)$, and $\SWAP = \Phi^{00} + \Phi^{01} + \Phi^{10} - \Phi^{11}$.   
    \item Test: execute each of the following with equal probability:
		\begin{enumerate}
		\item[(a)] Execute the Magic Square game, labeling each entry of the square from Figure~\ref{fig:ms} (except entry $(3,3)$, labeled as $Y_1Y_2$) using the observables $X_1,Z_1$ and $X_2,Z_2$.
		\item[(b)] Send $\Phi$ to one player and the labels $(X_1X_2,Z_1Z_2,Y_1Y_2)$ associated with the third column of the Magic Square to the other.  The first player replies with $a,b\in\{0,1\}$, and the second with $c,d,e\in \{\pm 1\}$. The referee checks the players' answers for the obvious consistency conditions. For example, if the first player reports the outcome $(0,0)$, then the referee rejects if $(c,d)\neq (+1,+1)$. 
		\item[(c)] Send $\Phi$ to one player and $\SWAP$ to the other. The first player replies with $a,b\in\{0,1\}$, and the second with $c\in \{\pm 1\}$. Accept if and only $c=(-1)^{ab}$. 
		\end{enumerate}
\end{itemize}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The Bell measurement test.}
\label{fig:bell}
\end{figure}


\begin{lemma}\label{lem:bell-rigid-test}
The test $\bellt(X_1,X_2,Z_1,Z_2)$ is a robust $(1,\delta)$ self-test for 
\begin{align*}
\mathcal{R}&= \Big\{\big\{\Phi^{ab}\big\}_{a,b\in\{0,1\}}\in\Proj,\, \SWAP\in\Obs\Big\}\cup \Big\{\Phi^{ab} = \frac{1}{4}\big(1+(-1)^a Z_1Z_2\big)\big(1+(-1)^bX_1X_2\big) \Big\}\\
&\qquad\qquad \cup \big\{\SWAP = \Phi^{00}+\Phi^{01}+\Phi^{10}-\Phi^{11}\big\},
\end{align*}
 for some $\delta(\eps) = O(\sqrt{\eps})$.
\end{lemma}


\begin{proof}
Completeness is clear: the players can play the honest strategy for the Magic Square game, use a measurement in the Bell basis on their two qubits for $\Phi$, and measure the SWAP observable~\eqref{eq:def-swap} for $\SWAP$. 

For soundness, let $\ket{\psi}\in\mH_\reg{A}\otimes \mH_\reg{B}$, $\{W_1W'_2:\, W,W'\in\{I,X,Z\}\}$, $\{\Phi^{ab}\}$ and $\SWAP$ denote a state and operators for a strategy that succeeds with probability at least $1-\eps$ in the test. From the analysis of the Magic Square game (Lemma~\ref{lem:ms-rigid}) it follows that the players' observables $X_1X_2$ and $Z_1Z_2$ associated to questions with those  labels approximately commute, and are each the product of two commuting observables $X_1I$, $IX_2$ and $Z_1I$, $IZ_2$ respectively, such that $X_1I$ and $Z_1I$, and $IX_2$ and $IZ_2$, anti-commute; all approximate identities hold up to error $O(\sqrt{\eps})$. 

Since $X_1X_2$ and $Z_1Z_2$ appear together in the same question (the last column of the Magic Square, Figure~\ref{fig:ms}), each player has a four-outcome projective measurement $\{W^{c,d}\}_{c,d\in\{0,1\}}$ such that $\sum_d (-1)^c W^{c,d} = X_1X_2$ and $\sum_c (-1)^dW^{c,d} = Z_1Z_2$, from which it follows that $W^{c,d} = (1/4)(1+(-1)^c Z_1Z_2)(1+(-1)^d X_1X_2)$. 

The player's success probability in part (b) of the test is then
\begin{align*}
\sum_{a,b} \bra{\psi} \Phi^{ab} \otimes W^{a,b} \ket{\psi} &= \sum_{a,b} \bra{\psi} \Phi^{ab} \otimes \frac{1}{4} \big(1+(-1)^a Z_1Z_2\big)\big(1+(-1)^bX_1X_2\big) \ket{\psi}.
\end{align*}
%&\approx_{\sqrt{\eps}} \sum_{a,b} \bra{\psi} \Id \otimes \frac{1}{4} \big(1+(-1)^a Z_1Z_2\big)\big(1+(-1)^bX_1X_2\big)\,\Phi^{a,b} \ket{\psi},
%\end{align*}
%where the second line uses the implicit consistency test to switch $\{\Phi^{a,b}\}$ from one player's space to the other. 
Using that, by assumption, $\{\Phi^{ab}\}$ is a projective measurement, the condition that this expression be at least $1-O(\eps)$ implies 
$$\Phi^{ab} \otimes \Id \approx_{\sqrt{\eps}}\Id \otimes \frac{1}{4}\big(1+(-1)^a Z_1Z_2\big)\big(1+(-1)^bX_1X_2\big).$$ 
Combining this with the implicit consistency test yields the first relation. The last is guaranteed by part (c) of the test, which checks for the correct relationship between $\SWAP$ and $\Phi$; the analysis is similar.  
\end{proof}


%---------------------------%
\subsection{The conjugation test}
\label{sec:conj-test}
%---------------------------%

We give a test which certifies that a unitary (not necessarily an observable) conjugates an observable to another. More precisely, let $A,B$ be observables, and $R$ a unitary, acting on the same space $\mH$. The test $\conj(R,C)$ certifies that the players implement observables of the form
\begin{equation}\label{eq:def-xr}
X_R = \begin{pmatrix} 0 & R^\dagger\\ R & 0 \end{pmatrix}\qquad \text{and}\qquad C = C_{A,B} = \begin{pmatrix} A & 0\\ 0 & B \end{pmatrix}
\end{equation}
such that $X_R$ and $C$ commute. The fact that $X_R$ is an observable implies that $R$ is unitary,\footnote{Note that $R$ will not be directly accessed in the test, since by itself it does not necessarily correspond to a measurement.} while the commutation condition is equivalent to the relation $RAR^\dagger = B$. The test thus tests for the relations
\begin{align*}
 \mathcal{C}\{R,C\} &= \big\{ X_R,C,X,Z\in \Obs\big\} \cup \big\{XZ=-ZX\big\}
\cup \big\{ X_R C = C X_R,\, X_RZ=-Z X_R,\, C Z=ZC\big\}.
\end{align*}
Here the anti-commuting observables $X$ and $Z$ are used to specify a basis in which $X_R$ and $C$ can be block-diagonalized. The anti-commutation and commutation relations with $Z$ enforce that $X_R$ and $C$ respectively have the form described in~\eqref{eq:def-xr}.
%: it is an easy exercise to verify that the relations $\mathcal{C}\{R,C\}$ imply that $X_R$ and $C$ can be put in the form~\eqref{eq:def-xr}, with the block structure specified by the $+1$ and $-1$ eigenspaces of $Z$.

\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~\conj(A,B,R) 
\begin{itemize}
    \item Inputs: $A$ and $B$ observables on the same space $\mH$, and $X$ and $Z$ observables on $\mH'$. $X_R$ and $C$ observables on $\mH\otimes \mH'$.
    \item Relations:  $\mathcal{C}\{R,C\} $, with $R$ defined from $X_R$, and $C$ related to $A$ and $B$, as in~\eqref{eq:def-xr}. 
    \item Test: execute each of the following with equal probability
		\begin{enumerate}
\item[(a)] With probability $1/8$ each, execute tests $\act(X,Z)$,  $\comt(C,Z)$, $\comt(X_R,C)$,   $\act(X_R,Z)$ and $\comt(A,X)$, $\comt(B,X)$, $\comt(A,Z)$, $\comt(B,Z)$. 
\item[(b)] Ask one player to measure $A$, $B$, $C$ or $Z$ (with probability $1/4$ each), and the other to jointly measure $A$ or $B$ (with probability $1/2$ each) and $Z$. The first player returns one bit, and the second two bits. Reject if either:
\begin{itemize}
\item The first player was asked $C$, the second player was asked $(A,Z)$, his second answer bit is $0$, and his first answer bit does not match the first player's;
\item The first player was asked $C$, the second player was asked $(B,Z)$, his second answer bit is $1$, and his first answer bit does not match the first player's.
\item The first player was asked $A$, $B$, or $Z$ and his answer bit does not match the corresponding answer from the second player. \anote{I'm being a little pedantic here, but maybe to be consistent we should add a consistency condition in test PROD(A,B,C) from page 6, similar to this last one.}\tnote{I didn't understand this comment. Can you add the condition you have in mind as a note?}
\end{itemize}
\end{enumerate}
\end{itemize}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The conjugation test, $\conj(A,B,R)$.}
\label{fig:conjugation-test-1}
\end{figure}

\begin{lemma}\label{lem:conj}
The test $\conj(A,B,R)$ is a $(1,\delta)$ self-test for the set of relations $\mathcal{C}\{R,C\}$, for some $\delta = O(\sqrt{\eps})$. Moreover, for any strategy that succeeds with probability at least $1-\eps$ in the test it holds that $C \approx_{\delta} A (\Id+Z)/2 + B(\Id-Z)/2$. 
\end{lemma}

\begin{proof}[Proof sketch.]
Completeness is clear, as players making measurements on a maximally entangled state on $\mH_{\reg{A}}\otimes \mH_{\reg{B}}$, tensored with an EPR pair on $\C^2 \otimes \C^2$ for the $X$ and $Z$ observables, and using $X_R$ and $C$ defined in~\eqref{eq:def-xr} (with the blocks specified by the space associated with each player's half-EPR pair) succeed in each test with probability $1$. 

We now consider soundness. Success in $\act(X,Z)$ in part (a) of the test implies the existence of local isometries $V_A,V_B$ such that $V_A:\mH_\reg{A}\to \mH_{\hat{\reg{A}}}\otimes \C^2_{\reg{A'}}$, with $X\simeq_{\sqrt{\eps}} \Id_{\hat{\reg{A}}}\otimes \sigma_X$ and $Z\simeq_{\sqrt{\eps}} \Id_{\hat{\reg{A}}}\otimes\sigma_Z$. By Lemma~\ref{lem:pauli-c}, approximate commutation with both $X$ and $Z$ implies that under the same isometry, $A\simeq_{\sqrt{\eps}} A_I \otimes \sigma_I$ and $B\simeq_{\sqrt{\eps}} B_I \otimes \sigma_I$, for observables $A_I, B_I$ on $\mH_{\hat{\reg{A}}}$. Similarly, the parts of the test involving $C$ and $X_R$ imply that they each have the block decomposition specified in~\eqref{eq:def-xr}. 

Next we analyze part (b) of the test. Let $\{W_{AZ}^{a,z}\}$ be the projective measurement applied by the second player upon query $(A,Z)$. Success with probability $1-O(\eps)$ in the first item ensures that 
$$\big| \bra{\psi} C \otimes (W_{AZ}^{00} - W_{AZ}^{10})\ket{\psi} \big| \,=\,O(\eps),$$
and a similar condition holds from the second item, with $W_{BZ}$ instead of $W_{AZ}$. Success with probability $1-O(\eps)$ in the third item ensures consistency of the POVM $\{W_{AZ}^{a,z}\}$ (resp. $\{W_{BZ}^{a,z}\}$) with the observable $A$ (resp. $B$)when marginalizing over the second outcome, and $Z$ when marginalizing over the second outcome. Using the decompositions for $A,B$ and $C$ derived from part (a) of the test, we we obtain the ``Moreover'' part of the lemma. 

Finally, success in test $\comt(X_R,C)$ from part (a) certifies the approximate commutation relation $[X_R,C]\approx_{\sqrt{\eps}} 0$, which given the block decomposition in~\eqref{eq:def-xr} implies $RAR^\dagger = B$, where we wrote $X_R \simeq R_X \otimes \sigma_X + R_Y \otimes \sigma_Y$, and use that $X_R$ is an observable to deduce that there exists a unitary $R$ on $\mH_{\hat{\reg{A}}}$ such that $R \approx R_X + i R_Y$. 
\end{proof}



%============================%
\section{The $n$-qubit Pauli group}
\label{sec:pauli-group}
%============================%

In this section we formulate a robust self-test for the $n$-qubit Pauli group. The result is a slight generalization of the results from~\cite{natarajan2016robust}, where the generalization is required to account for $\sigma_Y$ observables. 

%-----------------------------------%
\subsection{The $n$-qubit Weyl-Heisenberg group}
\label{sec:pbt}
%-----------------------------------den%

We start by giving a self-test for tensor products of $\sigma_X$ and $\sigma_Z$ 
observables acting on $n$ qubits, i.e. the $n$-qubit Weyl-Heisenberg group $\heisgn$. 
Let $\mathcal{P}^{(n)}$ denote the relations  
\begin{align*}
\paulin\{X,Z\} &= \Big\{ W(a)\in\Obs,\;W \in \prod_{i=1}^n \{X_i,Z_i\},\,a\in\{0,1\}^n\Big\}\\
&\qquad\cup \Big\{W(a)W'(a')=(-1)^{|\{i:\,W_i\neq W'_i \wedge a_ia'_i=1\}|} W'(a')W(a),\;\forall a,a'\in\{0,1\}^n\Big\}\\
&\qquad \cup\Big\{ W(a)W(a')=W(a+a'),\;\forall a,a'\in\{0,1\}^n\Big\}.
\end{align*}
Recall the notation $W(a)$ for the string that is $W_i$ when $a_i=1$ and $I$ otherwise. 
The first set of relations expresses the canonical anti-commutation relations. The second set of relations expresses that $X_i^2=Z_i^2=\Id$, coordinate-wise. It is easy to verify that $\mathcal{P}^{(n)}$ forms a defining set of relations for $\heisgn$. Our choice of relations is suggested by the Pauli braiding test introduced in~\cite{natarajan2016robust}, which shows that the relations are testable with a robustness parameter $\delta(\eps)$ that is independent of $n$. 
The underlying test is called the Pauli braiding test, and denoted $\pbt(X,Z)$. For convenience here we use a slight variant of the test, which includes more questions; the test is summarized in Figure~\ref{fig:pbt}. 

\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\pbt(X,Z)$: $X=X_1\cdots X_n$ and $Z=Z_1\cdots Z_n$ are two strings, where for each $i\in\{1,\ldots,n\}$, $X_i$ and $Z_i$ are anti-commuting observables on the $i$-th qudit. 
\begin{itemize}
\item Inputs: $(W,a)$, for $W\in\prod_{i=1}^n\{X_i,Z_i\}$ and $a\in\{0,1\}^n$.
\item Relations: $\paulin\{X,Z\}$.  
\item Test: Perform the following with probability $1/2$ each: 
\begin{enumerate}
\item[(a)] Select $W,W'\in \prod_i \{X_i,Z_i\}$, and $a,a'\in\{0,1\}^n$, uniformly at random. If $\{i: W_i\neq W'_i \wedge a_i=a'_i=1\}$ has even cardinality then execute test $\comt(W(a),W'(a'))$. Otherwise, execute test $\act(W(a),W'(a'))$. 
\item[(b)] Select $(a,a')\in\{0,1\}^n$ and $W\in\prod_{i=1}^n\{X_i,Z_i\}$ uniformly at random. Execute test $\prodt(W(a),W(a'),W(a+a'))$. 
\end{enumerate}
\end{itemize}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The Pauli braiding test, $\pbt(X,Z)$.}
\label{fig:pbt}
\end{figure}

The following lemma follows immediately from the definition of the relations  $\paulin\{X,Z\}$ and the analysis of the tests $\comt$, $\prodt$ and $\act$ given in Section~\ref{sec:elementary}. 


\begin{lemma}[Theorem 13~\cite{natarajan2016robust}]\label{lem:pbt}
The test $\pbt(X,Z)$ is a robust $(1,\delta)$ self-test 
for $\paulin\{X,Z\}$, for some $\delta(\eps) = O(\eps^{1/2})$. 
\end{lemma}

In addition we need the following lemma, which states that observables approximately satisfying the relations $\paulin\{X,Z\}$ are close to operators which, up to a local isometry, behave exactly as a tensor product of Pauli $\sigma_X$ and $\sigma_Z$ observables. 


\begin{lemma}[Theorem 14~\cite{natarajan2016robust}]\label{lem:pauli-stable}
The set of relations $\mathcal{P}^{(n)}$ is $\delta$-stable, with $\delta(\eps) = O(\eps)$.
\end{lemma}

Lemma~\ref{lem:pauli-stable} is proved in~\cite{natarajan2016robust} with a polynomial dependence of $\delta$ on $\eps$. The linear dependence can be shown by adapting the results of~\cite{gowers2015inverse} to the present setting; we omit the details. 

The following lemma is an extension of Lemma~\ref{lem:pauli-c} to the case of multi-qubit Pauli observables. A sequential application of Lemma~\ref{lem:pauli-c} would give a dependence of the error on the number of qubits; the following lemma avoids any such dependence. 

\begin{lemma}\label{lem:pauli-c-n}
Let $n$ be an integer, $\ket{\psi} \in \mH_{\reg{A}} \otimes \mH_{\reg{B}}$ and $A$ and $X(a)$, for $a\in\{0,1\}^n$, observables on $\mH_{\reg{A}}$ such that there exists an isometry $\mH_{\reg{A}} \simeq (\C^2)^{\otimes n}\otimes \mH_{\hat{\reg{A}}}$ under which the following conditions hold, for some $\delta_1,\delta_2,\delta_3$:
\begin{enumerate}
\item[(i)] There exists an observable $A'$ on $\mH_\reg{B}$ such that $A\otimes \Id \approx_{\delta_1} \Id \otimes A'$;
\item[(ii)] $\ket{\psi} \simeq_{\delta_1} \ket{\EPR}^{\otimes n}\ket{\aux}$, and $X(a)\simeq_{\delta_1} \sigma_X(a) \otimes \Id$;
\item[(iii)] $[A,X(a)]\simeq_{\delta_2} 0$;
\item[(iv)] For some $c\in\{0,1\}^n$ and $a\cdot c=1$, $\{A,X(a)\} \simeq_{\delta_3} 0$;
\end{enumerate}
where the first two conditions are meant on average over a uniformly random $a\in\{0,1\}^n$, and the last over a uniformly random $a$ such that $a\cdot c =1$. For $P\in\{I,X,Y,Z\}^n$ let $x_P \in\{0,1\}^n$ be such that $(x_P)_i=1$ if and only if $P_i\in\{Y,Z\}$.
Then there exists Hermitian $A_P$, for $P\in\{I,X,Y,Z\}^n$, on $\mH_{\hat{\reg{A}}}$ such that 
\begin{align*}
A \simeq_{\delta_1+\delta_2} \sum_{P\in\{I,X\}^n} \sigma_P \otimes A_P,\qquad\text{and}\qquad A \simeq_{\delta_1+\delta_3} \sum_{\substack{P\in\{I,X,Y,Z\}^n:\\ c_i=1 \implies P_i \in \{Y,Z\}\\  c_i=0 \implies P_i \in \{I,X\}}} \sigma_P \otimes A_P.
\end{align*}
 (A similar claim holds with $X$ replaced by $Z$.)
\end{lemma}

\begin{proof}
After application of the isometry, an arbitrary observable $\tilde{A}$ on  $(\C^2)^{\otimes n} \otimes \mH_{\hat{\reg{A}}}$ has a decomposition $\tilde{A} = \sum_{P\in\{I,X,Y,Z\}^n} \sigma_P \otimes A_P$, for Hermitian operators $A_P$ on $\mH_{\hat{\reg{A}}}$. 
 Then the analogue of~\eqref{eq:pauli-c-1} is
\begin{align*}
[\tilde{A},\sigma_X(a)\otimes \Id] &= 2 \,\sum_{P:\,a\cdot x_P=1} \,\sigma_P\sigma_X(a) \otimes A_P.
%\{\tilde{A},\sigma_X(a)\otimes \Id\} &=  2 \,\sum_{P:\,a\cdot x_P=0} \,\sigma_P\sigma_X(a) \otimes A_P.
\end{align*} 
Using that any string $x_P$ which is not the $0^n$ string satisfies $a\cdot x_P = 1$ with probability almost $1/2$ for a uniform choice of $a$, orthogonality of the $\sigma_P\sigma_X(a) $ for distinct $P$ lets us conclude the proof of the first relation as in Lemma~\ref{lem:pauli-c}. Similarly, the analogue of~\eqref{eq:pauli-c-2} gives
\begin{align*}
\{\tilde{A},\sigma_X(a)\otimes \Id\} &= 2 \,\sum_{P:\,a\cdot x_P=0} \,\sigma_P\sigma_X(a) \otimes A_P.
\end{align*} 
Using that any string $x_P$ which is not $c$ satisfies $a\cdot x_P = 0$ with probability almost $1/2$ for a uniform choice of $a$ such that $a\cdot c=1$, orthogonality of the $\sigma_P\sigma_X(a) $ for distinct $P$ lets us conclude the proof of the second relation.
\end{proof}









%
%%-----------------------------------%
%\subsection{The tensor product test}
%\label{sec:perm}
%%-----------------------------------%
%
%Before we move on to a test for the full Pauli group, including not only $X,Z$ but also $Y$ observables, we use the Pauli braiding test introduced in the previous section to develop a test verifying that observables respect a certain tensor product structure specified by $X$ and $Z$ observables.
%
%Let $k\geq 1$ be an integer and $S\subseteq \Obs((\C^2)^{\otimes k})$ a finite set of $k$-qubit observables (for us $k$ will always be a constant independent of $n$). The tensor product test $\perm(S,n)$ described in Figure~\ref{fig:clifford-test} certifies the use of $(nk)$-qubit observables obtained as the $n$-fold tensor product of observables from $S$.\footnote{The test, and part (d) in particular, bears some resemblance to the product test from~\cite{}. The idea is imilar --- testing permutation invariance --- but the details of the analysis are slightly different; we were not able to find a way to use the results from~\cite{}, including the ``unitary product test'' therein, as a black box.} 
%
%
%\begin{figure}[H]
%\rule[1ex]{16.5cm}{0.5pt}\\
%Test~$\perm(S,n)$: $S\subseteq \Obs((\C^2)^{\otimes k})$ a finite set of observables, for some $k\geq 1$. Assume without loss of generality that $S$ contains $\{X,Z\}^{\otimes k}$. Assume $n$ even. \\
%The verifier performs the following one-round interaction with two
%players. Select $W \in S^n$ uniformly at random. With equal probability,
%\begin{enumerate}
%\item[(a)] Let $X = X_1\cdots X_{nk}$ and $Z=Z_1\cdots Z_{nk}$. Execute test $\pbt(X,Z)$ on $nk$ qubits. 
%\item[(b)] For each $i\in\{1,\ldots,n\}$ let $W'_i\in\Obs((\C^2)^{\otimes k})$ be an observable that anti-commutes with $W_i$. Execute test $\pbt(W,W')$. 
%\item[(c)] Select $W' \in S^n$. Send $W$ to one player and $W'$ to the other. The players reply with $a,a'\in\{\pm 1\}^n$ respectively. The verifier rejects if there exists an $i$ such that $W_i=W'_i$ and $a_i\neq a'_i$.
%\item[(d)] Select a random permutation  $\sigma \in \mathfrak{S}_{n/2}$. Write $W=W_1 W_2$, where $W_1,W_2\in S^{n/2}$. Let $W_1^\sigma$ be the string $W_1$ with its entries permuted according to $\sigma$. Do the following with equal probability: 
%\begin{enumerate}
%\item[(i)] Send one player $W_1 W_1^\sigma$ and the other $W_1 W_2$ (resp. $W_2W_1^\sigma$), and check consistency of the first (resp. second) half of the players' answer bits.
%\item[(ii)] Send one player $W_1  W_1^\sigma$, and the other $\prod_i \Phi_{i,\sigma(i)}$, where each $\Phi_{i,\sigma(i)}$ designates a measurement in the Bell basis for $k$ pairs of qubits, where each pair has one qubit from the $i$-th chunk of $k$ consecutive qubits, and the other from the $\sigma(i)$-th chunk. 
    %The first player replies with $a\in\{\pm 1 \}^n$, and the second with $b\in (\{00,01,10,11\}^{k})^{n/2}$. For each
    %$i\in\{1,\ldots,n/2\}$ such that $b_i = 0^{2k}$, check that $a_i  = a_{\sigma(i)}$. 
%\item[(iii)] Execute $nk/2$ copies of test $\bellt$, for qubit pairs $(ki+t,kn/2+k\sigma(i)+t)$, for $i\in\{1,\ldots,n/2\}$ and $t\in\{0,\ldots,k-1\}$. 
%\end{enumerate}
%\end{enumerate}
%\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
%\caption{The tensor product test, $\perm(S,n)$.}
%\label{fig:clifford-test}
%\end{figure}
%
%\begin{lemma}\label{lem:perm-test}
%Let $k\geq 1$, $S\subseteq \Obs((\C^2)^{\otimes k})$ a finite set of observables, and $n$ an even integer. Suppose given a strategy for the players that has success at least $1-\eps$ in test $\perm(S,n)$. Then there exists a local isometry $V_A:\mH_{\reg{A}}\to ((\C^2)^{\otimes k})_{\reg{A}_1}\otimes \cdots\otimes ((\C^2)^{\otimes k})_{\reg{A}_n}\otimes {\mH}_{\hat{\reg{A}}}$, and observables $\sigma_{W} \in \Obs((\C^2)^{\otimes k}\otimes{\mH}_{\hat{\reg{A}}})$ for $W\in S$ such that 
%$$ \Es{W\in S^n} \big\|\big(W - (\prod_i \sigma_{W_i} ) V_A\big)\otimes \Id_{\reg{B}}\ket{\psi} \big\|^2 = O(\sqrt{\eps}),$$
%where in the product, the $i$-th $\sigma_{W_i}$ acts on registers $\reg{A}_i$ and $\hat{\reg{A}}$; moreover, $\sigma_{W_i}$ acting on distinct $\reg{A}_i$, $\reg{A}_j$ ($i\neq j$) commute (even though they all act on $\hat{\reg{A}}$ as well). 
%(The constant implied in the $O(\cdot)$ does not depend on $n$, but hides an exponential dependency on $k$.)
%\end{lemma}
%
%%The main content of the lemma is in the tensor product form of $\sigma_{W} = \otimes_i \sigma_{W_i}$, with $\sigma_{W_i}$ acting on the $i$-th chunk of $k$ qubits and depending on $W_i$ only. Aside from this tensor product structure nothing else is shown about the observable $\sigma_{W_i}$, which may be arbitrary. 
%
%\begin{proof}[Proof sketch.]
%Using Lemma~\ref{lem:pbt} and Lemma~\ref{lem:pauli-stable}, part (a) of the test implies the existence of a local isometry $V_A$ under which $\mH_{\reg{A}} \simeq (\otimes_i (\C^2)^{\otimes k}) \otimes {\mH}_{\hat{\reg{A}}}$, and under which each $(nk)$-qubit Pauli operator $P\simeq_{\sqrt{\eps}} \sigma_P$, for $P\in\{I,X,Z\}^{nk}$, and $\ket{\psi} \simeq_{\sqrt{\eps}} \ket{\EPR}^{\otimes nk} \ket{\aux}$. 
%
%Using part (b) of the test and Lemma~\ref{lem:pbt} it follows that under the same isometry an arbitrary $W\in S^n$ has a decomposition $W\simeq_{\sqrt{\eps}} \prod_i \tau_{W_i,i}$, for perfectly commuting observables $\tau_{W_i,i}$. However, a priori the observables $\tau_{W_i,i}$  do not necessarily respect the tensor product structure specified by the $\sigma_P$ obtained in part (a), so that each acts on the whole space $V_A \mH_{\reg{A}}$. %For each $i,W_i$, define 
%%$$\tau'_{W_i,i} = \Es{P\in\{X,Z\}^{k(n-1)} \times I^k} \,\sigma_P \,\tau'_{W_i,i} \,\sigma_P,$$
%%where the expectation is over all Pauli operators acting on all systems but the $i$-th. Then by definition $\tau'_{W_i,i}$ is supported on registers $\reg{A}_i$ and $\hat{\reg{A}}$ only. 
%
%Nevertheless, using the consistency checks from part (c) and part (a), $\tau_{W_i,i}$ (approximately) commutes with $\sigma_P$ for $P\in\{X,Z\}^{k(n-1)} \times I^k$ acting on all systems but the $i$-th. Applying Lemma~\ref{lem:pauli-c-n} (for both $X$ and $Z$) then implies that $\tau_{W_i,i}$ is close to an operator supported on the $i$-th chunk of $k$ qubits and $\hat{\mH}$ only. Thus $\tau_{W_i,i}$ has an expansion 
%$$ \tau_{W_i,i} \approx_{\sqrt{\eps}} \sum_{P\in\{I,X,Y,Z\}^k} \Id^{\otimes k(n-1)}\otimes  \sigma_{P,i} \otimes \Delta_{W_i,i}(P),$$
%with $\sigma_{P,i}$ acting on the $i$-th chunk only. Using Claim~\ref{claim:swap-tt} below, part (d) of the test checks that for $i\neq j$ but $W_i=W_j$, 
%$$\sum_P  \Delta_{W_i,i}(P) \Delta_{W_j,j}(P) \approx_{2^{k}\sqrt{\eps}} \Id_{\hat{\reg{A}}},$$
%which gives that $\tau_{W_i,i}$ depends on $W_i$ only, not on $i$. 
%\end{proof}



%-----------------------------------%
\subsection{The $n$-qubit Pauli group}
\label{sec:e-pbt}
%-----------------------------------%

We need an extended version of the Pauli braiding test introduced in Section~\ref{sec:pbt} which allows to test for a third observable, $Y_i$, on each system. Ideally we would like to enforce the relation $Y_i=\sqrt{-1}X_iZ_i$. Unfortunately, the complex phase cannot be tested from classical correlations alone: complex conjugation leaves correlations invariant, but does not correspond to a unitary change of basis  (see~\cite[Appendix A]{reichardt2012classicalarxiv} for an extended discussion of this issue). 

In our testing scenario the ``choice'' of complex phase, $\sqrt{-1}$ or its conjugate $-\sqrt{-1}$, is embodied by an observable $\Delta$ that the player measures on a system that is in a tensor product with all other systems on which the player acts. Informally, the outcome obtained when measuring $\Delta$ tells the player to use $Y = i XZ$ or $Y=-iXZ$. 

We first introduce $Y$ and test that the triple $\{X,Y,Z\}$ pairwise anticommute at each site. This corresponds to the following set of relations: 
\begin{align*}
& {\epaulin}\{X,Y,Z\} = \Big\{ W(a)\in\Obs,\;W \in \{X,Y,Z\}^n,\,a\in\{0,1\}^n\Big\} \\
&\qquad\cup \Big\{W(a)W'(a')=(-1)^{|\{i:\,W_i\neq W'_i \wedge a_ia'_i=1\}|} W'(a')W(a),\;\forall a,a'\in\{0,1\}^n\Big\}\\
&\qquad \cup\Big\{ W(a)W(a')=W(a+a'),\;\forall a,a'\in\{0,1\}^n\Big\}.
\end{align*}

\anote{I would spend an extra couple of lines describing in words part (c) of the test. It would make it easier to digest. }\tnote{added; see if it helps:}



\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\pbt(X,Y,Z)$: $X$, $Y$ and $Z$ are three mutually anti-commuting observables on a single qudit. 
\begin{itemize}
\item Inputs: $W\in\prod_{i=1}^n\{X,Y,Z\}$
\item Relations: $\epaulin\{X,Y,Z\}$.  
\item Test: Perform the following with equal probability: 
\begin{enumerate}
\item[(a)] Execute test $\pbt(X^n,Z^n)$. 
\item[(b)] Execute test $\pbt(Y^n,X^n)$ or test $\pbt(Y^n,Z^n)$, chosen with probability $1/2$ each.
\item[(c)] Select a random permutation  $\sigma \in \mathfrak{S}_{n/2}$, and $W\in  \{I,Y\}^n$ uniformly at random. Write $W=W_1 W_2$, where $W_1,W_2\in \{I,Y\}^{n/2}$. Let $W_1^\sigma$ be the string $W_1$ with its entries permuted according to $\sigma$. Do the following with equal probability: 
\begin{enumerate}
\item[(i)] Send one player $W_1 W_1^\sigma$ and the other $W_1 W_2$ (resp. $W_2W_1^\sigma$), and check consistency of the first (resp. second) half of the players' answer bits.
\item[(ii)] Send one player $W_1  W_1^\sigma$, and the other $\prod_i \Phi_{i,\sigma(i)}$, where each $\Phi_{i,\sigma(i)}$ designates a measurement in the Bell basis for the $(i,\sigma(i))$ pair of qubits. 
    The first player replies with $a\in\{\pm 1 \}^n$, and the second with $b\in \{00,01,10,11\}^{n/2}$. For each
    $i\in\{1,\ldots,n/2\}$ such that $b_i = 00$, check that $a_i  = a_{\sigma(i)}$. 
\item[(iii)] Execute $n/2$ copies of test $\bellt$ (in parallel), for qubit pairs $(i,n/2+\sigma(i))$, for $i\in\{1,\ldots,n/2\}$. 
\end{enumerate}
\end{enumerate}
\end{itemize}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The extended Pauli braiding test, $\pbt(X,Y,Z)$.}
\label{fig:e-pbt}
\end{figure}


The test is described in Figure~\ref{fig:e-pbt}. It has three components. Part (a) of the test executes test $\pbt(X^n,Z^n)$, which gives us multi-qubit Pauli $X$ and $Z$ observales. Part (b) of the test introduces observables labeled $Y(c)$, and uses tests $\pbt(Y^n,X^n)$ and $\pbt(Y^n,Z^n)$ to enforce appropriate anti-commutation relations with the Pauli $X$ and $Z$ observables obtained in part (a). Using Lemma~\ref{lem:pauli-c-n}, this part of the test will establish that the $Y(c)$ observables approximately respect the same $n$-qubit tensor product structure as $X(a)$ and $Z(b)$. 

Part (c) of the test is meant to control the ``phase'' ambiguity in the definition of $Y(c)$ that remains after the analysis of part (b). Indeed, from that part it will follow that $Y(c) \simeq \sigma_Y(c) \otimes \Delta(c)$, where $\Delta(c)$ is an arbitrary observable acting on the ancilla system produced by the isometry obtained in part (a). We would like to impose $\Delta(c) \approx \Delta_Y^{|c|}$ for a fixed observable $\Delta$, which will represent the irreducible phase degree of freedom in the definition of $Y$ discussed above. To obtain this, part (c) of the test performs a form of SWAP test between different $Y(c)$ observables, enforcing that e.g. $Y(1,0,1)$ is consistent with $Y(0,1,1)$ after an appropriate Bell measurement has ``connected'' registers $1$ and $2$. The swapping is defined using Pauli $\sigma_X$ and $\sigma_Z$, which leave the ancilla register invariant; consistency will then require $\Delta(1,0,1) \approx \Delta(0,1,1)$.  

\begin{lemma}\label{lem:xyz-rigid}
Suppose $\ket{\psi}\in\mH_\reg{A}\otimes \mH_\reg{B}$ and $W(a) \in \Obs(\mH_\reg{A})$, for $W\in \{X,Y,Z\}^n$ and $a\in\{0,1\}^n$, specify a strategy for the players that has success probability at least $1-\eps$ in the extended Pauli braiding test $\pbt(X,Y,Z)$ described in Figure~\ref{fig:e-pbt}. 
Then there exists isometries $V_D:\mH_\reg{D} \to ((\C^2)^{\otimes n})_{\reg{D'}}  \otimes \hat{\mH}_{\hat{\reg{D}}}$, for $D\in\{A,B\}$, such that
$$\big\| (V_A \otimes V_B) \ket{\psi}_{\reg{AB}} - \ket{\EPR}_{\reg{A}'\reg{B}'}^{\otimes n} \ket{\aux}_{\hat{\reg{A}}\hat{\reg{B}}} \big\|^2 = O(\sqrt{\eps}),$$
and for $W\in \{X,Y,Z\}^n$,
\begin{align}\label{eq:test-sigmay}
 \Es{a\in\{0,1\}^n} \big\| \big(W(a) -V_A^\dagger (\sigma_W(a) \otimes \Delta_W(a)) V_A\big) \otimes \Id_B \ket{\psi} \big\|^2 &= O(\sqrt{\eps}),
\end{align}
where $\Delta_W(a) = \prod_i \Delta_{W_i}^{a_i} \in \Obs({\mH}_{\hat{\reg{A}}})$ are observables with $\Delta_{X}=\Delta_{Z}=\Id$ and $\Delta_{Y}$ an arbitrary observable on $\hat{\mH}$ such that
	$$ \big\|\Delta_Y \otimes \Delta_Y \ket{\aux} - \ket{\aux} \big\|^2 = O(\sqrt{\eps}).$$
\end{lemma}

\begin{proof}[Proof sketch]
The existence of the isometries $V_A$ and $V_B$ follow from part (a) of the test and the combination of Lemma~\ref{lem:pbt} and Lemma~\ref{lem:pauli-stable}; see e.g.~\cite{natarajan2016robust} for an explicit construction. 
 Under this isometry we have $X(a) \simeq_{\sqrt{\eps}} \sigma_X(a)$ and $Z(b)\simeq_{\sqrt{\eps}} \sigma_Z(b)$, on average over $a,b\in\{0,1\}^n$. Applying the second part of Lemma~\ref{lem:pauli-c-n},  the  anti-commutation relations between $Y(c)$ and $X(a)$ and $Z(b)$ verified in part (b) of the test imply that under the same isometry,
$$ Y(c) \simeq \sigma_Y(c) \otimes {\Delta}(c),$$
for some observable ${\Delta}(c)$ on ${\mH}_{\hat{\reg{A}}}$. Using the linearity relations that are verified in the $\pbt$ test, we may in addition express $\Delta(c) = \prod_i \Delta_{i}^{c_i}$ for (perfectly) commuting observables $\Delta_i$. Using Claim~\ref{claim:swap-tt} below, success at least $1-O(\eps)$ in part (c) of the test then implies that on average over a random permutation $\sigma \in \mathcal{S}_{n/2}$, 
\begin{equation}\label{eq:delta-y-1}
 \Es{\sigma} \,\Es{c\in\{0,1\}^{n/2}}\,2^{-n}\Tr \big(\sigma_Y(c,c^\sigma)\big)\,\bra{\aux} \Big( \prod_{i=1}^{n/2}\big( \Delta_i \Delta_{n/2+ \sigma(i)} \big)^{c_i} \Big) \ket{\aux}  = 1- O(\sqrt{\eps}),
\end{equation}
where we wrote $(c,c^\sigma)$ for the $n$-bit string $(c_1,\ldots,c_{n/2},c_{\sigma(1)},\ldots,c_{\sigma(n/2)})$. Defining
 \begin{equation}\label{eq:delta-y-3}
\Delta_Y \,=\, \Es{i\in\{\frac{n}{2}+1,\ldots,n\}} \frac{\Delta_i}{|\Es{i} \Delta_i|},
\end{equation}
Eq.~\eqref{eq:delta-y-1} readily implies that $\Delta(c) \approx_{\sqrt{\eps}} \Delta_Y^{|c|}$. In slightly more detail, we first observe that
\begin{align}
\Es{c\in\{0,1\}^{n/2}} \Big\| \Big(\Delta(c) - \big(\Es{i\in\{\frac{n}{2}+1,\ldots,n\}} \Delta_{i}\big)^{|c|}\Big) \ket{\aux} \Big\|^2&\leq 
\Es{c} \Es{g:\{1,\ldots,\frac{n}{2}\}\to\{\frac{n}{2}+1,\ldots,n\}} \big\| \Delta(c) - \prod_i \Delta_{g(i)}^{c_i} \ket{\aux} \big\|^2.\label{eq:delta-y-2}
% &= 2 - 2\Es{c} \Es{g:\{1,\ldots,n/2\}\to\{n/2+1,\ldots,n\}} \bra{\aux} \prod_{i=1}^{n/2} \big(\Delta_i  \Delta_{g(i)}\big)^{c_i} \ket{\aux}\\
%&= O(\sqrt{\eps}),
%&\approx 2 - 2\Es{c} \Es{\sigma \in \mathcal{S}_{n/2}} \bra{\aux} \prod_{i=1}^{n/2} \big(\Delta_i  \Delta_{n/2+\sigma(i)}\big)^{c_i} \ket{\aux}
\end{align}
where the first inequality is by convexity, with the expectation taken over a random function $g$. We would like to relate this last term to the expection over a random permutation $\sigma\in\mathcal{S}_{n/2}$. One way to do this is to observe that with  probability $1-O(1/n)$ over the choice of a uniformly random $g$ it is possible to write
$$ \prod_i \Delta_{g(i)}^{c_i} = \Big(\prod_i \Delta_{n/2+\tau'(i)}^{c'_i}\Big)\Big(\prod_i \Delta_{n/2+\tau''(i)}^{c''_i}\Big),$$
where $c'_i+c''_i=c_i$ for all $i$, $\tau',\tau''$ are permutations such that $n/2+\tau'(i)=g(i)$ if $c'_i=c_i$, and $n/2+\tau''(i)=g(i)$ if $c''_i=c_i$; this is possible because $g$ might have two-element collisions, but is unlikely to have any three-element collisions. Moreover, for uniformly random $c$ and $g$ we can ensure that the marginal distribution on $(c',\tau')$ and $(c',\tau'')$ is uniform.  This allows us to use~\eqref{eq:delta-y-1} twice to bound the right-hand side of~\eqref{eq:delta-y-2} by $O(\sqrt{\eps})$ (after having expanded the square). As a consequence, $\Es{i}\Delta_i$ is close to an observable, and it is then routine to show that $\Delta_Y$ defined in~\eqref{eq:delta-y-3} satisfies $\Delta(c) \approx_{\sqrt{\eps}} \Delta_Y^{|c|}$, on average over a uniformly random $c$. 
 \tnote{I added some explanations, including a slightly more general claim. It is still a bit sloppy but should be more clear. Is it ok, or do we need more?} 

The last condition in the lemma follows from the consistency relations, which imply that $X(a)\otimes X(a)$, $Z(b)\otimes Z(b)$ and $Y(c)\otimes Y(c)$ all approximately stabilize $\ket{\psi}$; then $\Delta_Y^{|a|} \otimes \Delta_Y^{|a|} \approx  X(a)Z(a)Y(a) \otimes X(a)Z(a)Y(a)$ also does. 
\end{proof}

\begin{claim}\label{claim:swap-tt}
Let $A\in \Obs(\C^2_{\reg{A}_1}\otimes \cdots\otimes \C^2_{\reg{A}_k} \otimes \mH)$ and $B\in \Obs(\C^2_{\reg{B}_1}\otimes \cdots\otimes \C^2_{\reg{B}_k}\otimes \mH)$ be $k$-qubit observables acting on distinct registers $\reg{A}_j$, $\reg{B}_j$, as well as a common space $\mH$, and $\Phi_{\reg{A'B'}} = \prod_{j=1}^k \proj{\EPR}_{\reg{A'}_j,\reg{B'}_j}$ the the projector on $k$ EPR pairs across registers $\reg{A'}_j$ and $\reg{B'}_j$.  Then 
\begin{align}
 \Big(\bigotimes_j \bra{\EPR}_{\reg{A}_j\reg{A'}_j}\bra{\EPR}_{\reg{B}_j\reg{B'}_j} \otimes \Id_{\mH} \Big)&\Big(\big(A_{\reg{A}\mH} \otimes \Id_\reg{B}\big)\big( \Id_\reg{A}\otimes B _{\reg{B}\mH}\big)\otimes \Phi_{\reg{A'B'}}\Big) \Big(\bigotimes_j \ket{\EPR}_{\reg{A}_j\reg{A'}_j}\ket{\EPR}_{\reg{B}_j\reg{B'}_j} \otimes \Id_\mH\Big)\notag\\
& = \frac{1}{2^{2k}}\sum_i \Tr\big(A_i B_i\big) A'_iB'_i,\label{eq:swap}
\end{align}
where we write $A = \sum_i A_i \otimes A'_i$ and $B=\sum_i B_i\otimes B'_i$, for $A_i$ on $\mH_\reg{A}$, $B_i$ on $\mH_{\reg{B}}$, and $A'_i,B'_i$ on $\mH$.
\end{claim}


\begin{proof}
We do the proof for $k=1$, as the general case is similar. Using that for any operators $X_{\reg{AB}} $ and $ Y_{\reg{A'B'}}$, 
$$\bra{\EPR}_{\reg{AA'}}\bra{\EPR}_{\reg{BB'}} \big( X_{\reg{AB}} \otimes Y_{\reg{A'B'}} \big) \ket{\EPR}_{\reg{AA'}}\ket{\EPR}_{\reg{BB'}} \,=\, \frac{1}{4}\Tr(XY^T),$$
the left-hand side of~\eqref{eq:swap} evaluates to 
$$4^{-1} \Tr_{\reg{AB}}\big( \big(A_{\reg{A}\mH} \otimes \Id_\reg{B}\big)\big( \Id_\reg{A}\otimes B _{\reg{B}\mH}\big)\big(\Phi_{\reg{AB}}^T\otimes \Id_\mH\big)\big),$$
 which using the same identity again 
%$$\SWAP_{\reg{A' B'}} = \sum_{a,b\in\{0,1\}} \ket{a}\bra{b}_\reg{A'}\ket{b}\bra{a}_{\reg{B'}}$$
gives the right-hand side of~\eqref{eq:swap}.
\end{proof}



%=======================%
\section{Testing tensor products of Clifford observables}
\label{sec:clifford}
%=======================%

In this section we develop a test for $n$-fold tensor products of single-qubit or two-qubit Clifford observables. In Section~\ref{sec:n-clifford} we apply the Conjugation test from Section~\ref{sec:conj-test}  to test the relations that dictate how an arbitrary $n$-qubit Clifford unitary acts by conjugation on the Pauli matrices. In Section~\ref{sec:n-2-clifford} we specialize, and sharpen, the test to the case of unitaries that can be expressed as the $n$-fold tensor product of two-qubit Clifford observables.  


\subsection{Testing Clifford unitaries}
\label{sec:n-clifford}

Let $W$ be an $n$-qubit Clifford unitary. $W$ is characterized, up to phase, by its action by conjugation on the $n$-qubit Weyl-Heisenberg group. This action is described  by linear functions $h_S:\{0,1\}^n\times\{0,1\}^n \to \Z_4$ and $h_X,h_Z:\{0,1\}^n\times\{0,1\}^n \to \{0,1\}^n$ such that
\begin{equation}\label{eq:conj-cliff}
W \sigma_X(a)\sigma_Z(b) W^\dagger = i^{h_S(a,b)}\sigma_X(h_X(a,b))\sigma_Z(h_Z(a,b)),\qquad\forall a,b\in\{0,1\}^n.
\end{equation}
Since conjugation by $W$ preserves the Pauli anti-commutation relations it must be that $h_X(a,b)\cdot h_Z(a,b) = a\cdot b+h_S(a,b)\mod 2$.
 For any $a,b\in\{0,1\}^n$ define
\begin{equation}\label{eq:def-control-c}
A(a,b) = i^{a\cdot b}X(a)Z(b), \qquad B(a,b) = i^{a\cdot b}i^{h_S(a,b)}X(h_X(a,b))Z(h_Z(a,b)),
\end{equation}
where the additional phase $i^{a\cdot b}$ is introduced to ensure that $A(a,b)$ and $B(a,b)$ are observables. Define $C(a,b)$ in terms of $A(a,b)$ and $B(a,b)$ as in~\eqref{eq:def-xr}. 
%Each of $A$ and $B$ can be written in a unique way as a product of commuting single-qubit Pauli observables $\{X,Y,Z\}$. 
The Clifford conjugation test $\conjc(W)$ described in Figure~\ref{fig:conjugation-test-2} provides a test for the set of relations 
\begin{align*}
\conjr_{h_S,h_X,h_Z}\{W\} &= \paulin\{X,Y,Z\}  \cup \{W\in \Unitary\} \cup \{\Delta\in\Obs\}\\
&\qquad \cup \big\{ W X(a)Z(b)W^\dagger = (i\Delta)^{h_S(a,b)}X(h_X(a,b))Z(h_Z(a,b)),\,\forall a,b\in\{0,1\}^n\big\} \\
&\qquad \cup \big\{ \Delta X(a) = X(a)\Delta,\,\Delta Z(b)=Z(b)\Delta,\,\forall a,b\in\{0,1\}^n\big\}.
\end{align*}
Note the presence of the observable $\Delta$, which arises from the conjugation ambiguity in the definition of $Y$ (see Lemma~\ref{lem:xyz-rigid}). 
 
\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~\conjc(W): $W \in \mathcal{C}_n$ an $n$-qubit Clifford unitary. Let $h_S,h_X,h_Z$ be such that~\eqref{eq:conj-cliff} holds, and $A(a,b),B(a,b)$ the observables defined in~\eqref{eq:def-control-c}. \\
The verifier performs the following one-round interaction with two
players. With equal probability,
\begin{enumerate}
\item[(a)] Execute test $\pbt(X,Y,Z)$ on $(n+1)$ qubits, where the last qubit is called the ``control'' qubit;
%\item[(b)] Execute test $\perm(S,n)$ with $S = \{X,Y,Z\}$ (and $k=1$);
\item[(b)] Select $a,b\in\{0,1\}^n$ uniformly at random. Let $C(a,b)$ be the observable defined from $A(a,b)$ and $B(a,b)$ in~\eqref{eq:def-xr}, with the block structure specified by the control qubit. Execute test $\conj\{A(a,b),B(a,b),W\}$. In the test, to specify query $A(a,b)$ or $B(a,b)$, use the same label as for the same query when it is used in part (a) (which exists since by~\eqref{eq:def-control-c}, each of these observables can be expressed as a string in $\{I,X,Y,Z\}^n$).
%\item[(c)] Ask one player to measure either $X_W$ (the same observable used in $\conj(W))$, or $W$, or $X(e_{2n+1})$, and the other to measure the observables $(W, X(e_{n+1}))$, where in all cases the $X$ acts on the control qubit (the $(n+1)$-st). Check that the outcomes are consistent.
\end{enumerate}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The Clifford conjugation test, $\conjc(W)$.}
\label{fig:conjugation-test-2}
\end{figure}


\begin{lemma}\label{lem:cliff-conj}
Let $W$ be an $n$-qubit Clifford unitary and $h_S,h_X,h_Z$ such that~\eqref{eq:conj-cliff} holds. Suppose a strategy for the players succeed with probability at least $1-\eps$ in test $\conjc(W)$. Let $V_D:\mH_\reg{D} \to ((\C^2)^{\otimes (n+1)})_{\reg{D'}}  \otimes \hat{\mH}_{\hat{\reg{D}}}$ be the isometries from Lemma~\ref{lem:xyz-rigid}.  Let $\sigma_W$ be an $n$-qubit Clifford unitary satisfying~\eqref{eq:conj-cliff}, and $\sigma_{X_W}$ defined from $\sigma_W$ as $X_W$ from $W$ in~\eqref{eq:def-xr}, with the block structure specified by the $(n+1)$-st qubit . Then there exists an observable $\Delta_W$ on $\hat{\reg{A}}$ such that $X_W \simeq_{\sqrt{\eps}} \sigma_{X_W}\otimes \Delta_W$, under the same isometry.  
\end{lemma}

Note that the observable $\sigma_W$ in the lemma is uniquely defined by~\eqref{eq:conj-cliff}, up to phase. The observable $\Delta_W$ takes the phase ambiguity into account.

\begin{proof}[Proof sketch.]
 Completeness of the test is clear, as players making measurements on $(n+1)$ shared EPR pairs using standard Pauli observables, $W$, and $C(a,b)$ defined in~\eqref{eq:def-xr} with $A(a,b)$ and $B(a,b)$ as in~\eqref{eq:def-control-c} will pass all tests with probability $1$. 

Next we show soundness. The isometries $V_D$ follow from part (a) of the test and Lemma~\ref{lem:xyz-rigid}.
% success in part (a) of the test implies the existence of local isometries $V_A,V_B$ and observables $X(a,a')\approx_{\sqrt{\eps}} \sigma_X(a,a')$, $Y(c,c') \approx_{\sqrt{\eps}} \sigma_Y(c,c')\otimes \prod_i \Delta_i^{c_i}$ and $Z(b,b')\approx_{\sqrt{\eps}}\sigma_Z(b,b')$ for $a,b,c\in\{0,1\}^n$ and $a',b',c'\in\{0,1\}$. Using Lemma~\ref{lem:perm-test}, the permutation test from part (b) further implies that $\prod_i \Delta_i^{c_i} \approx_{\sqrt{\eps}} \Delta^{|c|}$ for some observable $\Delta$ independent of $i$. 
According to~\eqref{eq:def-control-c}, $A(a,b)$ and $B(a,b)$ can each be expressed (up to phase) as a tensor product of $X,Y,Z$ operators, where the number of occurrences of $Y$ modulo $2$ is $a\cdot b$ for $A(a,b)$ and $a\cdot b + h_S(a,b)$ for $B(a,b)$. Thus the labels used to specify the observables in $A(a,b)$ and $B(a,b)$ in part (b), together with the analysis of part (a), imply that up to phase, 
$$A(a,b) \simeq_{\sqrt{\eps}} \sigma_X(a)\sigma_Z(b) \otimes \Delta_Y^{a\cdot b}\qquad\text{and}\qquad B(a,b) \simeq_{\sqrt{\eps}} \sigma_X(h_X(a,b)) \sigma_Z(h_Z(a,b)) \otimes \Delta_Y^{a\cdot b + h_S(a,b)},$$
under the same isometry. 

Applying the analysis of the conjugation test given in Lemma~\ref{lem:conj} shows that $X_W$ must have the form in~\eqref{eq:def-xr}, for some $W$ that approximately conjugates $A(a,b)$ to $B(a,b)$, for all $a,b\in\{0,1\}^n$.

Let $\sigma_W$ be defined as in the lemma. From $\sigma_W$ we can define a basis by considering all $\sigma_W \sigma_X(a)\sigma_Z(b)$ for $a,b\in\{0,1\}^n$ . Expanding $W$ in this basis (after application of the isometry), $W \simeq \sum_{a,b} \sigma_W \sigma_X(a)\sigma_Z(b)\otimes \Delta_W(a,b)$ for arbitrary $\Delta_W(a,b)$ on $\mH_{\hat{\reg{A}}}$. Moreover, by considering conjugation relations involving an odd number of Pauli $Y$, we get that $\Delta_W$ (approximately) commutes with $\Delta_Y$. 
Using the approximate version of~\eqref{eq:conj-cliff} certified by the conjugation test and orthogonality of the Pauli matrices it then follows that $\Delta_W(a,b) \approx_{\sqrt{\eps}} 0$ on average over a uniformly random choice of $(a,b)\neq (0,0)$. Thus $W \simeq_{\sqrt{\eps}} \sigma_W \otimes \Delta_W$, for some $\Delta_W$ which we can take to be an observable. 

Finally,  the form for $X_W$ specified in the lemma follows since the control qubit used for the conjugation test is the $(n+1)$-st qubit certified by part (a) of the test.
\end{proof}

\subsection{The $n$-fold two-qubit Clifford group}
\label{sec:n-2-clifford}

We turn to testing observables in the $n$-fold direct product of the two-qubit Clifford group $\cliffordgb$. Any such observable is of course a $2n$-qubit Clifford unitary, so that the test developed in the previous section applies. In this section we specialize the test to such observables, and in addition show that the degree of freedom represented by the observable $\Delta_W$ from the previous section can be controlled. 

 Fix an arbitrary subset $\mathcal{G} \subseteq \cliffordgb \cap \Obs(\C^2\otimes \C^2)$ of two-qubit traceless Clifford observables.\footnote{The traceless condition is for convenience; we will see below where it is used.} An example is 
$$\mathcal{G} = \{IG,GI,IY,YI,IZ,ZI,CNOT\},$$
 which happens to be a generating set for the group $\cliffordgb$ (since $P = \frac{i-1}{\sqrt{2}} XG$).
 
\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\cliff(\mathcal{G},n)$: $\mathcal{G} \subseteq \cliffordgb \cap \Obs(\C^2\otimes \C^2)$; $n$ an even integer.  For any $G\in \mathcal{G}$, let $R=R(G)$ be a two-qubit unitary such that $RGR^\dagger = XI$ ($R$ exists since $G$ is assumed traceless). Let $\hat{\mathcal{G}}$ be the union of $\mathcal{G}$ and all such matrices $R(G)$ for $G\in\mathcal{G}$.\\
The verifier performs the following one-round interaction with two
players. Select $W \in \hat{\mathcal{G}}^n$ uniformly at random. With equal probability,
\begin{enumerate}
%\item[(a)] Execute test $\pbt(X,Y,Z)$ on $2n+1$ qubits;
\item[(a)] Execute the test $\conjc(W)$, with $W$ interpreted as a $2n$-qubit Clifford and the $(2n+1)$-st qubit serving as the control qubit; 
%\item[(b)] Execute the permutation test $\perm(S,n)$ where $S = \hat{\mathcal{G}}$ (and $k=2$);
\item[(b)] Let $C$ be the observable defined from $W$ and $X(\sum e_{2i+1})$ as in~\eqref{eq:def-xr}, and $R$ a unitary such that $R_i W_i R_i^\dagger = X(e_{2i+1})$ for each $i$.
Execute test $\conj\{W, X(\sum e_{2i+1}), R\}$. 
\item[(c)] Send one player either the query $W$, or $X_W$ and the other $(W,X(e_{n+1}))$. Receive one bit from the first player, and two from the second. Check that the first player's answer is consistent with the second player's first answer bit in case the query was $W$, and with the second in case the query was $X(e_{n+1})$. 
\end{enumerate}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The $2n$-qubit Clifford test, $\cliff(\mathcal{G},n)$.}
\label{fig:clifford-test-3}
\end{figure}

The test is described in Figure~\ref{fig:clifford-test-3}. It is divided in three parts. Part (a) of the test executes  $\conjc(W)$ to verify that an observable $W\in\mathcal{G}^n$ satisfies the appropriate Pauli conjugation relations~\eqref{eq:conj-cliff}. Note that a priori test $\conjc(W)$ only tests for the observable $X_W$ obtained from $W$ in blocks as $X_R$ from $R$ in~\eqref{eq:def-xr} (indeed, in that test $W$ need not be an observable). Thus part (c) of the test is introduced to verify that $X_W \approx W X(e_{n+1})$, where the $(n+1)$-st qubit is the one used to specify the block decomposition relating $X_W$ to $W$.  The result of parts (a) and (c) is that, under the same isometry as used to specify the Pauli $X$ and $Z$, $W\simeq \tau_W \otimes \Delta_W$, where $\tau_W$ is the ``honest'' $2n$-qubit Clifford observable (which is uniquely specified, up to phase, by its conjugation action on the Pauli group), and $\Delta_W$ is another observable acting on the ancilla system only. To verify that $\Delta_W$ is trivial, part (b) of the test verifies that $W$ can be conjugated, entrywise, to an $X$ observable (this is always possible under the assumption that each component of $W$ is traceless). Since $X$ is rigidly determined, this will suffice to enforce $\Delta_W \approx \Id$. 

\begin{theorem}\label{thm:clifford-ntest}
Suppose a strategy for the players succeeds in test $\cliff(\mathcal{G},n)$ (Figure~\ref{fig:clifford-test-3}) with probability at least $1-\eps$. Then  for $D\in\{A,B\}$ there exists an isometry 
$$V_D: \mathcal{H}_\reg{D} \to (\C^2)^{\otimes (2n+1)}_{\reg{D}'} \otimes \hat{\mH}_{\hat{\reg{D}}}$$
such that 
\begin{equation}\label{eq:psi-epr}
\big\| (V_A \otimes V_B) \ket{\psi}_{\reg{AB}} - \ket{\EPR}_{\reg{A}'\reg{B}'}^{\otimes (2n+1)} \ket{\aux}_{\hat{\reg{A}}\hat{\reg{B}}} \big\|^2 = O(\sqrt{\eps}),
\end{equation}
and %for any $W \in \mathcal{G}$ there is a $\Delta_W \in \Obs(\hat{\mH})$ such that the $\Delta_W$ pairwise commute and 
\begin{equation}\label{eq:clifford-ntest-close}
\Es{W\in\mathcal{G}^n} \big\| \Id_A \otimes \big( V_B W_B - \tau_{W} V_B\big)   \ket{\psi}_{\reg{AB}} \big\|^2 = O(\sqrt{\eps}).
\end{equation}
Here for $W\in\{I,X,Z\}^2\cap \mathcal{G}$, $\tau_W = \sigma_W$ are the regular Pauli matrices, and $\tau_Y = i\sigma_X\sigma_Z \otimes \Delta_Y$ as in Lemma~\ref{lem:xyz-rigid}, with $\Delta_Y$ an observable on ${\mH}_{\hat{\reg{A}}}$ such that  $\|(\Id_{\hat{\reg{A}}}\otimes \Delta_Y - \Delta_Y\otimes\Id_{\hat{\reg{B}}})\ket{\aux}\|=O(\sqrt{\eps})$. The remaining $\tau_W$ are defined using their expansion on $\tau_X,\tau_Y$, and $\tau_Z$, e.g. $\tau_G = (\sigma_X \otimes \Id + \sigma_Y\otimes \Delta_Y)/\sqrt{2}$.
\end{theorem}

\begin{proof}[Proof sketch]
The existence of the isometry, as well as~\eqref{eq:psi-epr} and~\eqref{eq:clifford-ntest-close} for $W \in \{I,X,Y,Z\}^{2n}$, follows from the test $\pbt(X,Y,Z)$, executed as part of the clifford conjugation test from part (a), and Lemma~\ref{lem:xyz-rigid}. 
Using part (a) of the test and Lemma~\ref{lem:cliff-conj} it moreover follows that every $W \in \mathcal{G}^n$ is mapped under the same isometry to $W \simeq_{\sqrt{\eps}} \tau_W \otimes \Delta_{W}$, where $\tau_W$ is as defined in the lemma (in particular, $\tau_X = \sigma_X$, etc.), and  $\Delta_W$ is an observable on $\hat{\reg{A}}$ which depends on the whole string $W$; 
 here we also use the consistency check in part (c) to relate  the observable $X_W$ used in the Clifford conjugation test with the observable $W$ used in part (b). 

The analysis of the conjugation test given in Lemma~\ref{lem:conj} shows that success with probability $1-O(\eps)$ in part (c) of the test implies the relations 
$$\tau_R \tau_W \tau_R^\dagger \otimes \Delta_R \Delta_W \Delta_R^\dagger \approx_{\sqrt{\eps}} \tau_X\big(\sum {e_{2i+1}}\big) = \sigma_X\big(\sum {e_{2i+1}}\big),$$
 on average over a uniformly random choice of $W\in \mathcal{G}$. Since by definition $\tau_R \tau_W \tau_R^\dagger = \tau_X(\sum e_{2i+1})$, uing that $\Delta_R$ is an observable such that $\Delta_R\otimes \Delta_R\ket{\aux}\approx\ket{\aux}$ (which follows from the implicit consistency tests), we obtain $\Delta_W \approx \Id$ for each $W\in\mathcal{G}\backslash\{I,X,Y,Z\}$. 

\end{proof}


\subsection{Post-measurement states}

We give a first corollary of Theorem~\ref{thm:clifford-ntest} which expresses its conclusion~\eqref{eq:clifford-ntest-close} in terms of the post-measurement state of the first player. It will be convenient (though not necessary) to assume that all observables in $\mathcal{G}$ come in non-trivial commuting pairs $(W,W')$, i.e. each of $W, W'$ and $WW'=W'W$ has rank $2$. This enforces that the two observables specify a rank-one basis of $\C^2\otimes \C^2$. We write $\{\sigma_{W,W',+1}^{u,u'}\}_{(u,u')\in\{\pm 1\}}$ for the associated family of rank-one projections, and $\{\sigma_{W,W',-1}^{u,u'}\}_{(u,u')\in\{\pm 1\}}$ for the rank-one projections obtained from the pair $(\overline{W},\overline{W'})$. 

\begin{corollary}\label{cor:clifford-rigid}
Let $\eps>0$, $n$ an integer and $\mathcal{G} \subseteq \cliffordgb\times\cliffordgb$ a finite set of pairs of commuting Clifford observables. Suppose a strategy for the players succeeds with probability $1-\eps$ in test $\ecliff(\mathcal{G},n)$. Then for $D\in\{A,B\}$ there exists an isometry 
$$V_D: \mathcal{H}_\reg{D} \to (\C^2)^{\otimes 2n} \otimes {\mH}_{\hat{\reg{D}}}$$
such that
$$ \big\| (V_A \otimes V_B) \ket{\psi}_{\reg{AB}}  - \ket{\EPR}^{\otimes 2n} \otimes \ket{\aux}_{\hat{\reg{A}}\hat{\reg{B}}} \big\|^2 = O(\sqrt{\eps}),$$
and orthogonal density matrices $\tau_\epsilon$ on $\hat{\reg{A}}$, for $\epsilon\in\{-1,1\}$, such that
$$ \mathop{\textsc{E}}_{W\in\mathcal{G}^n} \sum_{u\in\{\pm 1\}^{2n}} \Big\| V_A \Tr_{\reg{B}}\big((\Id_A \otimes W_{\reg{B}}^u) \proj{\psi}_{\reg{AB}} (\Id_A \otimes W_{\reg{B}}^u)^\dagger\big) V_A^\dagger - \sum_{\epsilon\in\{-1,1\}} \Big( \bigotimes_{i=1}^n \frac{\sigma_{W_{2i},W_{2i+1},\epsilon}^{u_{2i},u_{2i+1}}}{4}\Big)\otimes \frac{\tau_\epsilon}{2}   \Big\|_1 = O(\eps^c),$$
for some universal constant $c>0$. 
\end{corollary}

\begin{proof}
From Theorem~\ref{thm:clifford-ntest} we get isometries $V_A$, $V_B$ and an observable $\Delta_Y$ on ${\mH}_{\hat{\reg{A}}}$ such that the conclusions of the theorem hold. Let $\Delta_Y = \Delta_Y^{+1}-\Delta_Y^{-1}$ be the eigendecomposition, and 
$$\tau_{\epsilon} = \Tr_{\hat{\reg{B}}}\big( \big(\Id_{\hat{\reg{A}}}\otimes \Delta_Y^\epsilon \big)\proj{\aux}\big(\Id_{\hat{\reg{A}}}\otimes \Delta_Y^\epsilon\big)\big).$$
Using that $\Delta_Y \otimes \Delta_Y \ket{\aux} \approx \ket{\aux}$ it follows that $\tau_{+1}$ and $\tau_{-1}$ have (approximately) orthogonal support. 
Each observable $W(b)$, for $b\in\{0,1,2,3\}^n$, can be expanded in terms of the projective measurement $\{W^u\}$ applied by the player to define $W(b)$, as $W(b) = \sum_{u\in \{0,1,2,3\}^{n}}  \omega^{u\cdot b} W^u$, where $\omega = e^{\frac{2i\pi}{4}}$ (recall this is how the four-outcome observable $W(b)$ is defined in the first place), and we fixed an arbitrary bijection between $\{0,1\}^2$ and $\{0,1,2,3\}$ to define $W^u$. Similarly, by definition $\sigma_W(b) = \otimes_i (\sum_{u_i\in \{0,1,2,3\}} \omega^{u_ib_i} \sigma_{W_i}^{u_i})$. Thus
\begin{align*}
\Es{b\in\{0,1,2,3\}^n} \big\| \Id_A \otimes \big(  W_B(b) - V_B^\dagger \sigma_{W}(b) V_B\big)   \ket{\psi}_{\reg{AB}} \big\|^2
&= \Es{b\in\{0,1,2,3\}^n}\Big\| \sum_u \omega^{u\cdot b} \Id_A \otimes \big(  W_B^u - V_B^\dagger\sigma_{W}^u V_B\big)   \ket{\psi}_{\reg{AB}} \Big\|^2    \\
&= \sum_{u\in\{0,1,2,3\}^n}\big\|  \Id_A \otimes \big(  W_B^u - V_B^\dagger\sigma_{W}^u V_B\big)   \ket{\psi}_{\reg{AB}} \big\|^2,       
\end{align*}
where the second line is obtained by expanding the square and using $\Es{b \in \{0,1,2,3\}} \omega^{u \cdot b} = 1$ if $u=0$, and $0$ otherwise. 
Using~\eqref{eq:psi-epr} and the form of $\sigma_W$ indicated in Theorem~\ref{thm:clifford-ntest},
\begin{align*}
    \sum_{u\in\{0,1,2,3\}^n}\Big\|  \Tr_B \big( (\Id_A \otimes \sigma_{W}^u V_B)   \proj{\psi}_{\reg{AB}} (\Id_A \otimes \sigma_{W}^u V_B)^\dagger - \sum_{\epsilon\in\{-1,1\}} \Big( \bigotimes_{i=1}^n \frac{\sigma_{W_{2i},W_{2i+1},\epsilon}^{u_{2i},u_{2i+1}}}{4}\Big)\otimes \frac{\tau_\epsilon}{2}   \Big\|_1 = O(\sqrt{\eps}),
\end{align*}
where the factors $\frac{1}{4}$ correspond to the reduced density matrix of two EPR pairs, per observable $W_i$, on system $A$. 
\end{proof}


\subsection{Tomography}

Theorem~\ref{thm:clifford-ntest} and Corollary~\ref{cor:clifford-rigid} show that success in test $\cliff(\mathcal{G},n)$ gives us control on the players' observables and post-measurement states in the test. This allows us to use one of the players to perform some kind of limited tomography (limited to post-measurement states obtained from measurements in $\mathcal{G}$). Consider the test $\tom(\mathcal{G},n)$ described in Figure~\ref{fig:tomography-test}. In this test, one player is sent a random question $W\in\mathcal{G}^n$ distributed as in the test $\cliff(\mathcal{G},n)$ (i.e. uniformly at random), and asked to report his outcomes $a\in\Lambda$. From  Corollary~\ref{cor:clifford-rigid} it follows that the second player's post-measurement state is close to a state consistent with the first player's reported outcomes. Now suppose the second player, who is not sent any information, is allowed to report an arbitrary string $W'\in \mathcal{G}^n$, together with outcomes $u\in\Lambda$. Suppose also that for each $i$, $u_i=a_i$ whenever $W'_i=W_i$. Since the latter condition is satisfied by a constant fraction of $i\in\{1,\ldots,n\}$, irrespective of $W'$, with very high probability, it follows that the only possibility for the second player to satisfy the condition is to actually measure his qubits precisely in the basis that he indicates. This allows us to check that a player performs the measurement that he claims, even if the player has the choice of which measurement to report. 

\begin{figure}[H]
\rule[1ex]{16.5cm}{0.5pt}\\
Test~$\tom(\mathcal{G},n)$: $\mathcal{G} \subseteq \cliffordgb \cap \Obs(\C^2\otimes \C^2)$; $n$ an even integer.  \\
The verifier performs the following one-round interaction with two
players.  With equal probability,
\begin{enumerate}
%\item[(a)] Execute test $\pbt(X,Y,Z)$ on $2n+1$ qubits;
\item[(a)] Execute the test $\cliff(\mathcal{G},n)$; 
\item[(b)] Select $W\in\mathcal{G}^n$ uniformly at random. Send $W$ to the first player, and the signal ``$\tom(\mathcal{G},n)$'' to the second. Receive $a$ from the first player, and $W'\in\mathcal{G}^n$ and $u$ from the second. Accept only if $a_i=u_i$ whenever $W_i=W'_i$. 
\end{enumerate}
\rule[2ex]{16.5cm}{0.5pt}\vspace{-1cm}
\caption{The $2n$-qubit tomography test, $\tom(\mathcal{G},n)$.}
\label{fig:tomography-test}
\end{figure} 

\begin{corollary}\label{cor:clifford-rigid-adaptive}
Let $\eps>0$, $n$ an even integer and $\mathcal{G} \subseteq (\cliffordgb \cap \Obs(\C^2 \otimes \C^2))\cup\{B,C\}$. Let $\hat{\mathcal{G}} = (\mathcal{G}\backslash\{B,C\}) \cup \{XX,ZZ,YY\}$. Suppose a strategy for the players succeeds with probability $1-\eps$ in test $\tom(\hat{\mathcal{G}},n)$. Let $V_A,V_B$ be the isometries specified in Corollary~\ref{cor:clifford-rigid-adaptive}. Let $\{Q^{W',u}\}$ be the POVM applied by the second player in part (b) of the test. Then there exists a distribution $q$ on $\hat{\mathcal{G}}^n \times \{\pm 1\}$ such that 
\begin{align*}
 \sum_{W'\in\hat{\mathcal{G}}^n} \sum_{u\in\prod_i \Lambda_i} &\Big\| \Tr_{\reg{A}\hat{\reg{B}}} \big((\Id_A \otimes V_B Q^{W',u} )\proj{\psi}_{\reg{AB}} (\Id_A \otimes V_B Q^{W',u})^\dagger\big)\\
&\hskip3cm - \sum_{\epsilon\in\{-1,1\}}  q(W',\epsilon)  \Big( \bigotimes_{i=1}^n \frac{1}{4}\sigma_{W'_i,\epsilon}^{u_i}\Big) \Big\|_1 = O(\sqrt{\eps}),
\end{align*}
where the notation is the same as in Corollary~\ref{cor:clifford-rigid}. 
\end{corollary}

\begin{proof}
Success in part (a) of the test allows us to apply Corollary~\ref{cor:clifford-rigid-adaptive}. For any $(W',u)$ let $\rho_{\reg{A'}}^{W',u}$ be the post-measurement state on the first player's space, conditioned on the second player's answer  in part (b) of the test being $(W',u)$, and after application of the isometry $V_A$. Using~\eqref{eq:psi-epr} and the properties of the maximally entangled state,  this is approximately the same as the second player's post-measurement state, 
\begin{equation}\label{eq:tom-1}
\big\|\rho_{\reg{A'}}^{W',u} - \Tr_{\reg{A}\hat{\reg{B}}}\big((\Id_A\otimes V_B Q^{W',u} )\proj{\psi}_{\reg{AB}}(\Id_A\otimes V_B Q^{W',u} )^\dagger\big)\big\|_1 \,=\, O(\sqrt{\eps}).
\end{equation}
On the other hand, using that for any $i\in\{1,\ldots,n\}$, $W_i=W'_i$ with constant probability $|\hat{\mathcal{G}}|^{-1}$, 
it follows from~\eqref{eq:clifford-ntest-close} in Theorem~\ref{thm:clifford-ntest} that success in part (b) of the test implies the condition
\begin{equation}\label{eq:tom-2}
\sum_{W',\epsilon }\Tr(\tau_\epsilon) \sum_u\, \Tr\Big(\Big( \frac{|\hat{\mathcal{G}}|-1}{|\hat{\mathcal{G}}|}\Id + \frac{1}{|\hat{\mathcal{G}}|}\sigma_{W',\epsilon}^u \Big) \rho_{\reg{A'}}^{W',u}\Big)  = 1- O(\sqrt{\eps}). 
\end{equation}
Combining~\eqref{eq:tom-1} and~\eqref{eq:tom-2} concludes the proof, for some distribution $q(W',\epsilon) \approx \sum_u \Tr(\rho_{\reg{A'}}^{W',u})\Tr(\tau_\epsilon)$ (the approximation is due to the fact that the latter expression only specifies a distribution up to error $O(\sqrt{\eps})$. 
\end{proof}

%
%\subsection{Adaptive $n$-fold two-qubit Clifford group}
%
%\tnote{6/5: old section; no longer needed?} 
%
  %Let $k_1, k_2, ..., k_l$ and $k_{< i} = \sum_{j < i} k_j$ and for $i > 1$, let $f_{i} :
  %\mathcal{G}^{k_{1}} \times \{0,1\}^{k_{<i}}
  %\rightarrow \mathcal{G}^{k_i}$. 
%
  %We would like a  game that such that first we send $W \in \mathcal{G}^{k_1}$
  %for the first player, who supposedly measures the first $k_1$ qubits according
  %to the observables $W$ and has output $o_1 \in \{0,1\}^{k_1}$. The first
  %player then measures the
  %next $k_2$ qubits with the observables $f_2(W, o_1)$, with output $o_2 \in
  %\{0,1\}^{k_2}$. The first player continues by measuring the next $k_3$ qubits
  %with the observables $f_3(S, o_1o_2)$, and so on.
%
  %Let $E_{W,o}$ be the set of observables that the first player should have
  %applied when his input is $W$ and his output is $o = o_1,...,o_l$, i.e.,
  %$E_{W,o} = W f_2(W,o_1) f_3(W,o_1o_2) .... f_l(W, o_1...o_{l-1})$.
%
  %Ideally we want have a game such that we could conclude something similar to
  %the next theorem.
%
%
%\begin{theorem}
%Suppose a strategy for the players succeeds in $\cliff(\mathcal{G},n)$ (Figure~\ref{fig:clifford-test-3}) with probability at least $1-\eps$. Then  for $D\in\{A,B\}$ there exists an isometry 
%$$V_D: \mathcal{H}_\reg{D} \to (\C^2)^{\otimes (2n+1)}_{\reg{D}'} \otimes \hat{\mH}_\reg{D}$$
%such that 
%\begin{equation}
%\big\| (V_A \otimes V_B) \ket{\psi}_{\reg{AB}} - \ket{\EPR}_{\reg{A}'\reg{B}'}^{\otimes (2n+1)} \ket{\aux}_{\hat{\reg{A}}\hat{\reg{B}}} \big\|^2 = O(\sqrt{\eps}),
%\end{equation}
  %and if the first player answers $o = o_1...o_l$ when asked $W \in
  %\mathcal{G}^{k_1}$ then
%\begin{equation}
  %\Es{W\in\mathcal{G}^{k_1}} \Es{b\in\{0,1\}^n}\big\| \big( V_A {E_{W,o}}_A(b) -
  %\sigma_{E_{W,o}}(b) V_A\big) \otimes I_B   \ket{\psi}_{\reg{AB}} \big\|^2 = O(\sqrt{\eps}).
%\end{equation}
%\end{theorem}
%
%\tnote{This shouldn't be hard to prove. Two questions: can we say what the observables are in each iteration? Is it always the same set? Is it the case that in the honest strategy the outcomes $o_i$ should be uniformly distributed, so the choice of observable in each iteration should also be uniform (if we just consider the marginal distribution)? If this is the case maybe we can avoid having the $\eps$ add up with the number of rounds; I'm not sure}

\bibliography{delegation}

\notesendofpaper

\end{document}
